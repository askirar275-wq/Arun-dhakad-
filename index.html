<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatApp ‚Äî OTP + Firestore Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
    .card { background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.15); margin-bottom:20px; }
    .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; transition:0.2s; }
    .btn:hover { opacity:0.8; }
    .btn-primary { background:#007bff; color:white; }
    input { padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; margin-top:8px; }
    #chatArea { height:250px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa; margin-top:10px; }
    .msg { padding:6px 10px; margin:4px 0; border-radius:8px; display:inline-block; max-width:80%; }
    .me { background:#007bff; color:white; align-self:flex-end; }
    .other { background:#eee; color:#333; }
    .chat-wrapper { display:flex; flex-direction:column; }
  </style>
</head>
<body>

  <!-- OTP Login -->
  <section class="card" id="loginCard">
    <h3>‡§≤‡•â‡§ó‡§ø‡§® OTP ‡§∏‡•á</h3>
    <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (‡§ú‡•à‡§∏‡•á: +91 9xxxxxxxxx)</label>
    <input id="phone" type="text" placeholder="+91..." />
    
    <div id="recaptcha-container" style="margin-top:12px"></div>
    
    <div style="margin-top:12px;display:flex;gap:10px">
      <button id="sendBtn" class="btn btn-primary">Send OTP</button>
      <button id="signOutBtn" class="btn">Sign Out</button>
    </div>

    <label style="margin-top:12px">OTP ‡§°‡§æ‡§≤‡•á‡§Ç</label>
    <input id="otp" type="text" placeholder="6-digit code" />
    <button id="verifyBtn" class="btn btn-primary" style="margin-top:10px">Verify</button>

    <div id="status" style="margin-top:12px;color:#555">‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞...</div>
  </section>

  <!-- Chat Area -->
  <section class="card" id="chatCard" style="display:none;">
    <h3>‡§ö‡•à‡§ü</h3>
    <div id="chatArea" class="chat-wrapper"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="message" type="text" placeholder="Message..." />
      <button id="sendMsg" class="btn btn-primary">Send</button>
    </div>
  </section>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // ‚úÖ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAYiCfR1-UrHO4URnkkzVmqDEiHdWOvFZ8",
      authDomain: "chatapp-66809.firebaseapp.com",
      projectId: "chatapp-66809",
      storageBucket: "chatapp-66809.firebasestorage.app",
      messagingSenderId: "513053373469",
      appId: "1:513053373469:web:d99d27f12f0176c5e2c2f4",
      measurementId: "G-T32WEZW4LW"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // reCAPTCHA setup
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      size: 'normal',
      callback: (response) => { console.log("‚úÖ reCAPTCHA solved"); },
      'expired-callback': () => { console.log("‚ö†Ô∏è reCAPTCHA expired"); }
    });

    // Send OTP
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const phoneNumber = document.getElementById("phone").value;
      try {
        const appVerifier = window.recaptchaVerifier;
        const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
        window.confirmationResult = confirmationResult;
        document.getElementById("status").innerText = "‚úÖ OTP ‡§≠‡•á‡§ú ‡§¶‡•Ä ‡§ó‡§à!";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "‚ùå Error: " + error.message;
      }
    });

    // Verify OTP
    document.getElementById("verifyBtn").addEventListener("click", async () => {
      const code = document.getElementById("otp").value;
      try {
        const result = await window.confirmationResult.confirm(code);
        document.getElementById("status").innerText = "üéâ Login Success: " + result.user.phoneNumber;
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("chatCard").style.display = "block";
        loadChat(result.user.phoneNumber);
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "‚ùå Error: " + error.message;
      }
    });

    // Sign Out
    document.getElementById("signOutBtn").addEventListener("click", async () => {
      await signOut(auth);
      document.getElementById("status").innerText = "üö™ Signed out";
      document.getElementById("loginCard").style.display = "block";
      document.getElementById("chatCard").style.display = "none";
    });

    // Load chat messages
    function loadChat(myNumber) {
      const q = query(collection(db, "messages"), orderBy("time", "asc"));
      onSnapshot(q, (snapshot) => {
        const chatArea = document.getElementById("chatArea");
        chatArea.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "msg " + (data.sender === myNumber ? "me" : "other");
          div.innerText = data.text;
          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      });

      // Send message
      document.getElementById("sendMsg").onclick = async () => {
        const msg = document.getElementById("message").value;
        if (msg.trim() === "") return;
        await addDoc(collection(db, "messages"), {
          text: msg,
          sender: myNumber,
          time: serverTimestamp()
        });
        document.getElementById("message").value = "";
      };
    }
  </script>
</body>
</html>
