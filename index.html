<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fruit Cut â€” Fixed Start âœ…</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#00ffd5;
    --accent-2:#ff6b6b;
    --bg1:#071018;
    --bg2:#071a2c;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Roboto,Segoe UI}
  body{background:radial-gradient(100% 100% at 50% 0%,var(--bg2) 0%,var(--bg1) 60%,#000 100%);color:#e6f7f7;overflow:hidden}

  #wrap{position:fixed;inset:0}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block;touch-action:none}

  .hud{position:fixed;left:12px;right:12px;top:12px;display:flex;gap:10px;justify-content:space-between;align-items:center;pointer-events:none}
  .pill{pointer-events:auto;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);font-weight:700}
  .score{color:var(--accent)} .lives{color:#ffd6a5}

  .controls{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;display:flex;gap:10px;justify-content:center;pointer-events:auto}
  .btn{padding:10px 14px;border-radius:999px;border:2px solid rgba(0,255,213,0.18);background:transparent;color:var(--accent);font-weight:700;cursor:pointer;outline:none}
  .btn.hidden{display:none}

  /* START overlay - big & obvious */
  #startOverlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
    z-index:40;backdrop-filter: blur(4px)
  }
  #startCard{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.18));padding:26px;border-radius:18px;border:1px solid rgba(255,255,255,0.06);text-align:center;box-shadow:0 24px 60px rgba(0,0,0,0.6)}
  #startBtnBig{font-size:20px;padding:14px 26px;border-radius:999px;border:3px solid var(--accent);background:transparent;color:var(--accent);font-weight:800;cursor:pointer}
  .small{font-size:13px;color:#dfe;padding-top:8px}

  #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .panel{pointer-events:auto;min-width:300px;padding:16px;border-radius:12px;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.16));border:1px solid rgba(255,255,255,0.06)}
  .hidden{display:none}

  .toast{position:fixed;left:50%;top:64px;transform:translateX(-50%);padding:8px 14px;border-radius:10px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.06);font-weight:700;pointer-events:none;z-index:60}
  .comboPop{position:fixed;left:50%;top:48%;transform:translate(-50%,-50%);font-size:36px;font-weight:800;color:#fff;text-shadow:0 8px 40px rgba(0,0,0,.8);pointer-events:none;opacity:0;transition:opacity .18s, transform .18s}
  .comboPop.show{opacity:1;transform:translate(-50%,-54%) scale(1.04)}
  .help{position:fixed;left:12px;bottom:12px;color:#cde;opacity:.72;font-size:12px;z-index:50}
  @media (max-width:520px){#startCard{width:88vw}}
</style>
</head>
<body>
<div id="wrap"><canvas id="game"></canvas></div>

<div class="hud">
  <div class="pill score">Score: <span id="scoreVal">0</span></div>
  <div class="pill lives">Lives: <span id="livesVal">3</span></div>
</div>

<div class="controls" style="pointer-events:auto">
  <button id="pauseBtn" class="btn hidden">Pause</button>
  <button id="muteBtn" class="btn hidden">Mute</button>
  <button id="themeBtn" class="btn">Theme</button>
  <button id="boardBtn" class="btn">Leaderboard</button>
</div>

<!-- Big start overlay (must click/tap) -->
<div id="startOverlay" aria-hidden="false">
  <div id="startCard" role="dialog" aria-modal="true">
    <div style="font-size:26px;font-weight:800;color:var(--accent)">Fruit Cut</div>
    <div style="margin-top:10px">Tap to Start â€¢ Swipe to cut fruits â€¢ Avoid ðŸ’£</div>
    <button id="startBtnBig" style="margin-top:14px">START</button>
    <div class="small">If audio doesn't play, tap anywhere on screen once more after start.</div>
  </div>
</div>

<div id="overlay">
  <div id="gameOverPanel" class="panel hidden">
    <h2 style="margin:6px 0 6px;color:var(--accent-2);font-size:22px">GAME OVER</h2>
    <p style="margin:2px 0">Score: <strong id="finalScore">0</strong></p>
    <div style="margin-top:10px">
      <button id="retryBtn" class="btn">Play Again</button>
    </div>
    <div style="margin-top:12px;text-align:left">
      <h3 style="font-size:15px;margin:8px 0 6px">Top Scores</h3>
      <ol id="boardList" style="padding-left:18px;margin:0"></ol>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>
<div id="comboPop" class="comboPop">COMBO x2!</div>
<div class="help">Swipe to cut â€¢ Tap START</div>

<script>
/* Simplified & defensive version focused on reliable start */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: true });
let DPR = Math.min(window.devicePixelRatio || 1, 2);
function resize(){ DPR = Math.min(window.devicePixelRatio || 1, 2); canvas.width = Math.floor(window.innerWidth * DPR); canvas.height = Math.floor(window.innerHeight * DPR); canvas.style.width = window.innerWidth + 'px'; canvas.style.height = window.innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
resize(); addEventListener('resize', resize);

/* Elements */
const startOverlay = document.getElementById('startOverlay');
const startBtnBig = document.getElementById('startBtnBig');
const pauseBtn = document.getElementById('pauseBtn');
const muteBtn  = document.getElementById('muteBtn');
const themeBtn = document.getElementById('themeBtn');
const boardBtn = document.getElementById('boardBtn');
const retryBtn = document.getElementById('retryBtn');
const scoreVal = document.getElementById('scoreVal');
const livesVal = document.getElementById('livesVal');
const finalScore = document.getElementById('finalScore');
const boardList = document.getElementById('boardList');
const gameOverPanel = document.getElementById('gameOverPanel');
const toast = document.getElementById('toast');
const comboPop = document.getElementById('comboPop');

/* Game state & constants (slower fruits) */
const FRUITS = ['ðŸ‰','ðŸŽ','ðŸŠ','ðŸ‹','ðŸ“','ðŸ','ðŸ¥'];
const BOMB = 'ðŸ’£';
let fruits=[], bombs=[], pieces=[], particles=[], trails=[];
let running=false, paused=false, muted=false;
let score=0, lives=3; let spawnTimer=0; let recentCuts=[], bestComboInRun=0;

const GRAVITY = 0.40;
const INIT_VY_MIN = -9.5, INIT_VY_MAX = -7.2;
const INIT_VX = 3.0;
const FRICTION = 0.998;

/* Themes */
const THEMES = [{name:'Neon Night', bg1:'#071018', bg2:'#071a2c', accent:'#00ffd5'} , {name:'Sunset Pop', bg1:'#1a092b', bg2:'#3b0b37', accent:'#ff78d1'}];
let themeIndex = 0;
function applyTheme(t){ document.documentElement.style.setProperty('--bg1', t.bg1); document.documentElement.style.setProperty('--bg2', t.bg2); document.documentElement.style.setProperty('--accent', t.accent); }
applyTheme(THEMES[themeIndex]);

/* Audio: init on user gesture (safe) */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx=null, musicGain=null, sfxGain=null, musicNode=null;
function ensureAudio(){
  try{
    if(actx) return;
    actx = new AudioCtx();
    musicGain = actx.createGain(); musicGain.gain.value = 0.06;
    sfxGain = actx.createGain(); sfxGain.gain.value = 0.35;
    musicGain.connect(actx.destination); sfxGain.connect(actx.destination);
    // start a gentle oscillator melody (non-blocking)
    musicNode = actx.createOscillator();
    musicNode.type = 'sine';
    const gain = actx.createGain(); gain.gain.value = 0.03;
    musicNode.connect(gain); gain.connect(musicGain);
    musicNode.start();
    // change frequency occasionally
    setInterval(()=>{ if(!musicNode) return; const base = 200 + Math.random()*120; musicNode.frequency.setTargetAtTime(base, actx.currentTime, 0.5); }, 1600);
  }catch(e){
    console.warn('Audio init failed', e);
  }
}
function playCut(){ if(!actx || muted) return; const o = actx.createOscillator(), g = actx.createGain(); o.type='square'; o.frequency.value = 680; g.gain.value = 0.001; o.connect(g); g.connect(sfxGain); o.start(); g.gain.exponentialRampToValueAtTime(0.35, actx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.12); o.stop(actx.currentTime+0.14); }
function playBomb(){ if(!actx || muted) return; const bufferSize = 2*actx.sampleRate; const buffer = actx.createBuffer(1, bufferSize, actx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1)*Math.pow(1-i/bufferSize,2); const noise = actx.createBufferSource(); noise.buffer=buffer; const g = actx.createGain(); g.gain.value=0.5; const bq = actx.createBiquadFilter(); bq.type='lowpass'; bq.frequency.value=220; noise.connect(bq); bq.connect(g); g.connect(sfxGain); noise.start(); noise.stop(actx.currentTime+0.35); }

/* Leaderboard */
const BOARD_KEY = 'fruitcut_board_v1';
function loadBoard(){ try{ return JSON.parse(localStorage.getItem(BOARD_KEY) || '[]'); }catch(e){ return []; } }
function saveBoard(arr){ localStorage.setItem(BOARD_KEY, JSON.stringify(arr.slice(0,5))); }
function addToBoard(sc){ const arr = loadBoard(); arr.push({score:sc, at:Date.now()}); arr.sort((a,b)=>b.score-a.score); saveBoard(arr); return arr.slice(0,5); }
function renderBoard(listEl){ const arr = loadBoard(); listEl.innerHTML=''; arr.forEach((it,i)=>{ const li=document.createElement('li'); const d=new Date(it.at); li.textContent = `${i+1}. ${it.score} â€” ${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`; listEl.appendChild(li); }); }

/* Utils */
function rand(min,max){ return Math.random()*(max-min)+min; }
function distPointToSegment(px,py,x1,y1,x2,y2){ const dx=x2-x1, dy=y2-y1, l2=dx*dx+dy*dy; if(l2===0) return Math.hypot(px-x1,py-y1); let t=((px-x1)*dx+(py-y1)*dy)/l2; t=Math.max(0,Math.min(1,t)); const sx=x1+t*dx, sy=y1+t*dy; return Math.hypot(px-sx,py-sy); }

/* Spawning (slower) */
function spawn(){ const baseX = rand(window.innerWidth*0.2, window.innerWidth*0.8); const cluster = Math.random() < 0.10 ? (2 + Math.floor(Math.random()*2)) : 1; for(let i=0;i<cluster;i++){ const isBomb = Math.random() < 0.12; const obj={ isBomb, emoji: isBomb?BOMB:FRUITS[Math.floor(Math.random()*FRUITS.length)], x: baseX + rand(-70,70), y: window.innerHeight + 60 + Math.random()*40, vx: rand(-INIT_VX,INIT_VX), vy: rand(INIT_VY_MAX, INIT_VY_MIN), size: isBomb?rand(46,58):rand(40,52), rot: rand(-0.06,0.06), alive:true, id:Math.random() }; (isBomb?bombs:fruits).push(obj); } }

/* Particles & pieces */
function burst(x,y,color='#ffd66b'){ for(let i=0;i<12;i++){ particles.push({ x,y, vx:rand(-4,4), vy:rand(-6,-1), g:0.18, r:rand(2,5), life:40+Math.random()*30, color }); } }
function addPieces(f){ const spread = 3.5; pieces.push({emoji:f.emoji,side:'L',x:f.x-2,y:f.y,vx:f.vx-spread,vy:f.vy-1.2,rot:f.rot-0.05,size:f.size,life:28}); pieces.push({emoji:f.emoji,side:'R',x:f.x+2,y:f.y,vx:f.vx+spread,vy:f.vy-1.2,rot:f.rot+0.05,size:f.size,life:28}); }

/* Input & trail */
let pointerDown=false; let trails=[]; function addTrail(x,y){ trails.push({x,y,t:Date.now()}); if(trails.length>120) trails.shift(); } function clearTrailSoon(){ setTimeout(()=> trails=[], 80); }
function getPointer(e){ if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY}; return {x:e.clientX, y:e.clientY}; }

canvas.addEventListener('mousedown', (e)=>{ pointerDown=true; addTrail(getPointer(e).x, getPointer(e).y); ensureAudio(); });
canvas.addEventListener('mousemove', (e)=>{ if(!pointerDown) return; const p=getPointer(e); const last=trails[trails.length-1]; if(!last||Math.hypot(p.x-last.x,p.y-last.y)>3) addTrail(p.x,p.y); });
canvas.addEventListener('mouseup', ()=>{ pointerDown=false; clearTrailSoon(); });

canvas.addEventListener('touchstart', (e)=>{ pointerDown=true; const p=getPointer(e); addTrail(p.x,p.y); ensureAudio(); e.preventDefault(); }, {passive:false});
canvas.addEventListener('touchmove', (e)=>{ if(!pointerDown) return; const p=getPointer(e); const last=trails[trails.length-1]; if(!last||Math.hypot(p.x-last.x,p.y-last.y)>2.5) addTrail(p.x,p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener('touchend', ()=>{ pointerDown=false; clearTrailSoon(); }, {passive:false});

/* Combo */
const COMBO_WINDOW = 380;
let recentCutsArr = [];
function registerCut(){ const now = Date.now(); recentCutsArr = recentCutsArr.filter(t=> now - t <= COMBO_WINDOW); recentCutsArr.push(now); const c = recentCutsArr.length; if(c>=2){ const bonus = c-1; score += bonus; scoreVal.textContent = score; bestComboInRun = Math.max(bestComboInRun, c); comboPop.textContent = `COMBO x${c}!`; comboPop.classList.add('show'); setTimeout(()=> comboPop.classList.remove('show'), 420); } }

/* Slicing check */
function checkSlicing(){
  if(trails.length<2) return false;
  const pts = trails.slice(-18);
  for(let s=0;s<pts.length-1;s++){
    const a=pts[s], b=pts[s+1];
    for(let i=fruits.length-1;i>=0;i--){
      const f = fruits[i];
      const d = distPointToSegment(f.x,f.y,a.x,a.y,b.x,b.y);
      if(d < f.size*0.55){
        fruits.splice(i,1);
        score += 1; scoreVal.textContent = score;
        burst(f.x,f.y); addPieces(f); playCut(); registerCut();
      }
    }
    for(let i=bombs.length-1;i>=0;i--){
      const bo = bombs[i];
      const d = distPointToSegment(bo.x,bo.y,a.x,a.y,b.x,b.y);
      if(d < bo.size*0.6){
        playBomb(); endGame(); return true;
      }
    }
  }
  return false;
}

/* Update & draw */
function update(){
  if(!running || paused) return;
  spawnTimer -= 1;
  if(spawnTimer <= 0){ spawn(); spawnTimer = 26 + Math.floor(Math.random()*18); }

  fruits.forEach(f=>{ f.vy += GRAVITY; f.x += f.vx; f.y += f.vy; f.vx *= FRICTION; });
  bombs.forEach(b=>{ b.vy += GRAVITY; b.x += b.vx; b.y += b.vy; b.vx *= FRICTION; });
  pieces.forEach(p=>{ p.vy += GRAVITY*0.9; p.x += p.vx; p.y += p.vy; p.rot += (p.side==='L'?-0.05:0.05); p.life -= 1; });
  particles.forEach(pr=>{ pr.vy += pr.g; pr.x += pr.vx; pr.y += pr.vy; pr.life -= 1; });

  for(let i=fruits.length-1;i>=0;i--){ const f=fruits[i]; if(f.y - f.size > window.innerHeight + 80){ fruits.splice(i,1); lives -= 1; livesVal.textContent = lives; if(lives<=0){ endGame(); return; } } }
  for(let i=bombs.length-1;i>=0;i--){ const b=bombs[i]; if(b.y - b.size > window.innerHeight + 80) bombs.splice(i,1); }
  for(let i=pieces.length-1;i>=0;i--) if(pieces[i].life<=0) pieces.splice(i,1);
  for(let i=particles.length-1;i>=0;i--) if(particles[i].life<=0) particles.splice(i,1);

  trails = trails.filter(pt => (Date.now() - pt.t) < 220);
  checkSlicing();
}

function draw(){
  ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
  const w = canvas.width/DPR, h = canvas.height/DPR;
  const grd = ctx.createLinearGradient(0,0,0,h); grd.addColorStop(0,'rgba(255,255,255,0.02)'); grd.addColorStop(1,'rgba(0,0,0,0.06)'); ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);

  fruits.forEach(f=>{ ctx.save(); ctx.translate(f.x,f.y); ctx.rotate(f.rot); ctx.font = Math.floor(f.size) + 'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowColor='rgba(0,0,0,.5)'; ctx.shadowBlur=10; ctx.fillText(f.emoji,0,0); ctx.restore(); });
  bombs.forEach(b=>{ ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.rot); ctx.font = Math.floor(b.size) + 'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.shadowColor='rgba(255,80,80,.18)'; ctx.shadowBlur=12; ctx.fillText(b.emoji,0,0); ctx.restore(); });
  pieces.forEach(p=>{ ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); const sz = Math.floor(p.size); ctx.font = sz + 'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.beginPath(); if(p.side==='L') ctx.rect(-sz, -sz, sz, sz*2); else ctx.rect(0, -sz, sz, sz*2); ctx.clip(); ctx.fillText(p.emoji,0,0); ctx.restore(); });
  particles.forEach(pr=>{ ctx.beginPath(); ctx.globalAlpha = Math.max(0, Math.min(1, pr.life/60)); ctx.fillStyle = pr.color; ctx.arc(pr.x, pr.y, pr.r, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; });

  if(trails.length>1){ ctx.lineJoin = ctx.lineCap = 'round'; for(let i=0;i<trails.length-1;i++){ const a=trails[i], b=trails[i+1]; const age = Date.now() - a.t; const alpha = 1 - Math.min(1, age/220); ctx.strokeStyle = `rgba(0,255,213,${alpha*.95})`; ctx.lineWidth = 8 * (1 - i/trails.length) + 2; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); } }

  requestAnimationFrame(loop);
}
function loop(){ update(); draw(); }

/* Start / End */
function startGame(){
  try{
    ensureAudio(); // audio should init on the user tap
  }catch(e){ console.warn('audio safe init failed', e); }
  fruits=[]; bombs=[]; pieces=[]; particles=[]; trails=[];
  score=0; lives=3; bestComboInRun=0; recentCutsArr=[];
  scoreVal.textContent=score; livesVal.textContent=lives;
  running=true; paused=false; spawnTimer=6;
  pauseBtn.classList.remove('hidden'); muteBtn.classList.remove('hidden');
  startOverlay.style.display='none';
  gameOverPanel.classList.add('hidden');
  overlay.setAttribute('aria-hidden','true');
  requestAnimationFrame(loop);
  showToast('Game started â€” swipe to cut!');
}
function endGame(){
  running=false; paused=false;
  finalScore.textContent = score;
  addToBoard(score);
  renderBoard(boardList);
  gameOverPanel.classList.remove('hidden');
  overlay.setAttribute('aria-hidden','false');
  pauseBtn.classList.add('hidden'); muteBtn.classList.add('hidden');
  showToast('Game Over â€” score saved');
}

function togglePause(){ paused = !paused; pauseBtn.textContent = paused ? 'Resume' : 'Pause'; showToast(paused ? 'Paused' : 'Resumed'); }

/* UI helpers */
function showToast(msg){
  toast.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=> toast.classList.add('hidden'), 1100);
}

/* Button wiring */
startBtnBig.addEventListener('click', ()=>{ startGame(); });
retryBtn.addEventListener('click', ()=>{ startGame(); });
pauseBtn.addEventListener('click', ()=>{ togglePause(); });
muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted ? 'Unmute' : 'Mute'; if(actx){ sfxGain.gain.setTargetAtTime(muted?0:0.35, actx.currentTime, 0.02); musicGain.gain.setTargetAtTime(muted?0:0.06, actx.currentTime, 0.08); } showToast(muted ? 'Muted' : 'Unmuted'); });
boardBtn.addEventListener('click', ()=>{ renderBoard(boardList); gameOverPanel.classList.remove('hidden'); overlay.setAttribute('aria-hidden','false'); });
themeBtn.addEventListener('click', ()=>{ themeIndex = (themeIndex+1)%THEMES.length; applyTheme(THEMES[themeIndex]); showToast('Theme: '+THEMES[themeIndex].name); });

/* Keyboard */
addEventListener('keydown', (e)=>{ if(e.key===' '){ if(!running) startGame(); else togglePause(); } if(e.key==='m'){ muted = !muted; muteBtn.click(); } });

/* initial board */
renderBoard(boardList);

/* tiny safety: if start overlay not tapped, still allow tapping anywhere to start */
document.body.addEventListener('click', function bodyStarter(e){
  if(startOverlay.style.display !== 'none'){ // only before start
    // if user tapped outside big button, still start (mobile accidental taps)
    if(e.target !== startBtnBig){
      // small grace: ignore if tap on control buttons
      const skip = e.target.closest('.controls') || e.target.closest('.panel');
      if(!skip) startGame();
    }
  }
}, {once:false});

/* debug helper: if something throws, show toast and log */
window.addEventListener('error', (ev)=>{ console.error('Uncaught error', ev.error); showToast('Error: check console'); });

</script>
</body>
  </html>
