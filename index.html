<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>üçì Fruit Pro ‚Äî Fury (Pro Level)</title>
<style>
:root{
  --bg1:#041026; --bg2:#052a3a;
  --panel: rgba(255,255,255,0.03);
  --outline: rgba(255,255,255,0.10);
  --accent:#ff6b6b; --accent2:#ffbf59;
  --glass: rgba(255,255,255,0.03);
  --font: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);-webkit-font-smoothing:antialiased;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#eaf6ff}
.app{height:100vh;display:flex;align-items:stretch;justify-content:center}
.stage{position:relative;width:100vw;height:100vh;overflow:hidden}
canvas{display:block;width:100%;height:100%;touch-action:none;background:
  radial-gradient(900px 360px at 8% 18%, rgba(255,255,255,0.02), transparent), linear-gradient(180deg,#041026 0%, #052a3a 100%)}
.ui-top{position:absolute;left:12px;top:12px;z-index:60;display:flex;gap:8px;align-items:center}
.chip{padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-weight:800}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:80}
.card{pointer-events:auto;min-width:300px;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--outline);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;cursor:pointer;user-select:none;background:transparent;border:2px solid rgba(255,255,255,0.08);transition:transform .14s,box-shadow .14s;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
.btn:active{transform:translateY(3px) scale(.995)}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#071026;font-weight:900}
.btn.ghost{background:transparent;color:#eaf6ff}
.small{font-size:13px;opacity:0.86}
.toast{position:absolute;bottom:22px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);display:none;z-index:90}
.combo-popup{position:absolute;left:50%;top:12%;transform:translateX(-50%);font-weight:900;color:#ffd86b;font-size:28px;text-shadow:0 8px 22px rgba(0,0,0,0.6);pointer-events:none;display:none;z-index:90}
.achievement-list{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
.toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)}
.settings-row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.center-emoji{font-size:36px}
.badge{padding:6px 8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-weight:700}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="stage" id="stage">
    <canvas id="canvas" aria-label="Fruit Pro canvas"></canvas>

    <!-- top UI -->
    <div class="ui-top" id="uiTop" aria-hidden="false" style="z-index:70">
      <div class="chip">Score: <span id="uiScore">0</span></div>
      <div class="chip">Lives: <span id="uiLives">3</span></div>
      <div class="chip">Level: <span id="uiLevel">1</span></div>
    </div>

    <!-- floating fx root -->
    <div id="fxRoot" style="position:absolute;inset:0;pointer-events:none;z-index:75"></div>

    <div class="combo-popup" id="comboPopup"></div>
    <div class="toast" id="toast"></div>

    <!-- overlay for home / gameover / settings -->
    <div class="overlay" id="overlayRoot" aria-hidden="false"></div>
  </div>
</div>

<script>
/* Fruit Pro ‚Äî Pro-level build
   Features:
    - Home Screen with settings + highscore + achievements
    - Fullscreen canvas (responsive)
    - Fruit halves + juice splash
    - Golden & Slow fruits, Bomb
    - Combo system, Achievements saved in localStorage
    - WebAudio sfx + vibration on bomb
   ‡§∏‡§≠‡•Ä comments ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç‡•§
*/

/* ---------- canvas setup ---------- */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: true });
const stage = document.getElementById('stage');
const overlayRoot = document.getElementById('overlayRoot');
const fxRoot = document.getElementById('fxRoot');
const toastEl = document.getElementById('toast');
const comboPopup = document.getElementById('comboPopup');

function fitCanvas(){
  const rect = stage.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  canvas.width = Math.max(480, Math.floor(rect.width * dpr));
  canvas.height = Math.max(420, Math.floor(rect.height * dpr));
}
window.addEventListener('resize', ()=>{ fitCanvas(); render(); });
fitCanvas();

/* ---------- utilities ---------- */
const rand = (a,b)=> a + Math.random()*(b-a);
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));

/* ---------- game config ---------- */
const DIFF = {
  easy:   { vyMin:-1.6, vyMax:-3.0, spawnMs:1400, maxEnt:12 },
  medium: { vyMin:-2.8, vyMax:-5.0, spawnMs:1000, maxEnt:18 },
  hard:   { vyMin:-4.6, vyMax:-8.0, spawnMs:650,  maxEnt:28 }
};
let difficulty = 'medium';
let spawnMultiplier = 1.0;
let soundOn = true;

/* ---------- persistent save ---------- */
const SAVE_KEY = 'fruit_pro_save_v1';
let Save = { high:0, coins:0, achievements:{} };
function loadSave(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(raw){ Save = JSON.parse(raw); }
    else Save = { high:0, coins:0, achievements:{} };
  }catch(e){}
}
function saveAll(){ localStorage.setItem(SAVE_KEY, JSON.stringify(Save)); }

/* ---------- UI helpers ---------- */
function showToast(msg, ms=1200){
  toastEl.textContent = msg; toastEl.style.display = 'block';
  if(window._toastTimer) clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=>{ toastEl.style.display = 'none'; window._toastTimer = null; }, ms);
}

/* ---------- entities ---------- */
class Entity {
  constructor({x,y,vx,vy,r,type,emoji,color,score,meta}){
    this.x = x; this.y = y; this.vx = vx; this.vy = vy;
    this.r = r; this.type = type; this.emoji = emoji; this.color = color; this.score = score||0;
    this.ang = Math.random()*Math.PI*2; this.spin = (Math.random()-0.5)*0.4;
    this.hit = false; this.meta = meta||{}; this.life = 4000; this.bounces = 0;
  }
  update(dt, slow=1){
    const gravity = 0.02 * (1/slow) * (1 + Math.max(0, game.level - 1)*0.03);
    this.vy += gravity * (dt/16);
    this.x += this.vx * (dt/16); this.y += this.vy * (dt/16);
    this.ang += this.spin * (dt/16);
    // bounce floor for pieces and bombs
    const floorY = canvas.height - 6;
    if((this.type === 'piece' || this.type==='bomb') && this.y + this.r > floorY){
      this.y = floorY - this.r;
      if(Math.abs(this.vy) > 1.4 && this.bounces < 3){
        this.vy = -Math.abs(this.vy) * 0.52; this.vx *= 0.84; this.bounces++;
      } else { this.vy = 0; this.vx *= 0.96; }
    }
    // keep inside horizontal
    const minX = this.r + 6, maxX = canvas.width - this.r - 6;
    if(this.x < minX){ this.x = minX; this.vx = Math.abs(this.vx)*0.6; }
    if(this.x > maxX){ this.x = maxX; this.vx = -Math.abs(this.vx)*0.6; }
    if(this.type === 'piece') this.life -= dt;
  }
  render(ctx, dpr){
    ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.ang);
    if(this.type === 'bomb'){
      ctx.beginPath(); ctx.fillStyle = '#111'; ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.strokeStyle = '#ffcc4d'; ctx.lineWidth = Math.max(1, dpr*1.2);
      ctx.moveTo(-this.r*0.2, -this.r*0.85); ctx.lineTo(this.r*0.5, -this.r*1.45); ctx.stroke();
    } else {
      ctx.font = `${this.r}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(this.emoji, 0, 0);
      if(this.meta && this.meta.special === 'gold'){
        ctx.beginPath(); ctx.strokeStyle = 'rgba(255,220,90,0.12)'; ctx.lineWidth = Math.max(6,dpr*1.8);
        ctx.arc(0,0,this.r*1.05,0,Math.PI*2); ctx.stroke();
      }
    }
    ctx.restore();
  }
}

/* ---------- spawn rules ---------- */
const FRUITS = [
  {emoji:'üçé', color:'#ff6b6b', score:10},
  {emoji:'üçä', color:'#ff9b3d', score:10},
  {emoji:'üçâ', color:'#ff4d6d', score:12},
  {emoji:'üçå', color:'#fff27a', score:9},
  {emoji:'üçá', color:'#b58cff', score:12},
  {emoji:'ü•≠', color:'#ffd07a', score:11},
  {emoji:'üçê', color:'#c6f08f', score:10},
  {emoji:'üçì', color:'#ff4d8a', score:13}
];

function spawnEntity(){
  const diff = DIFF[difficulty];
  if(entities.length >= Math.round(diff.maxEnt * spawnMultiplier)) return;
  const w = canvas.width, h = canvas.height;
  const x = rand(w*0.12, w*0.88);
  const y = h + rand(20, 80);
  const vy = diff.vyMin + Math.random()*(diff.vyMax - diff.vyMin);
  const vx = (Math.random()-0.5) * Math.max(0.6, Math.abs(vy)*0.18);
  const r = Math.round(rand(34, 48) * (window.devicePixelRatio || 1));
  const sroll = Math.random();
  if(sroll < 0.12){ // bomb chance ~12%
    entities.push(new Entity({x,y,vx,vy,r,type:'bomb',emoji:'üí£',color:'#222',score:0}));
  } else if(sroll > 0.995){
    const f = pick(FRUITS);
    entities.push(new Entity({x,y,vx,vy,r,type:'fruit',emoji:f.emoji,color:f.color,score:(f.score*6), meta:{special:'gold'}}));
  } else if(sroll > 0.985){
    const f = pick(FRUITS);
    entities.push(new Entity({x,y,vx,vy,r,type:'fruit',emoji:f.emoji,color:f.color,score:(f.score*2), meta:{special:'slow'}}));
  } else {
    const f = pick(FRUITS);
    entities.push(new Entity({x,y,vx,vy,r,type:'fruit',emoji:f.emoji,color:f.color,score:f.score}));
  }
}

/* ---------- juice particles ---------- */
function spawnJuice(x,y,color,count=28,spread=6){
  for(let i=0;i<count;i++){
    particles.push({
      x,y,
      vx: rand(-spread, spread),
      vy: rand(-8, -1),
      life: rand(500,1300),
      t:0,
      size: rand(1.6, 3.6),
      color
    });
  }
}

/* ---------- splitting ---------- */
function splitToPieces(f){
  const px = f.x, py = f.y;
  const baseR = Math.max(16, Math.round(f.r * 0.56));
  const left = new Entity({
    x: px - 6, y: py,
    vx: f.vx - rand(1.6,3.2),
    vy: f.vy * 0.28 + rand(1.2,3.8),
    r: baseR, type:'piece', emoji:f.emoji, color:f.color, score: Math.round((f.score||10)/2)
  });
  const right = new Entity({
    x: px + 6, y: py,
    vx: f.vx + rand(1.6,3.2),
    vy: f.vy * 0.28 + rand(1.0,3.4),
    r: baseR, type:'piece', emoji:f.emoji, color:f.color, score: Math.round((f.score||10)/2)
  });
  left.spin *= 1.8; right.spin *= 1.8;
  entities.push(left, right);
}

/* ---------- slice detection & combo ---------- */
function pointSegDist(px,py,x1,y1,x2,y2){
  const A = px - x1, B = py - y1, C = x2 - x1, D = y2 - y1;
  const dot = A*C + B*D; const len_sq = C*C + D*D;
  let param = -1; if(len_sq !== 0) param = dot / len_sq;
  let xx, yy;
  if(param < 0){ xx = x1; yy = y1; } else if(param > 1){ xx = x2; yy = y2; } else { xx = x1 + param*C; yy = y1 + param*D; }
  return Math.hypot(px-xx, py-yy);
}

function processStroke(){
  const pts = game.path;
  if(pts.length < 2) return 0;
  let hits = 0;
  for(let s=0;s<pts.length-1;s++){
    const a = pts[s], b = pts[s+1];
    for(let i = entities.length - 1; i >= 0; i--){
      const e = entities[i];
      if(e.hit) continue;
      const d = pointSegDist(e.x, e.y, a.x,a.y, b.x,b.y);
      if(d < e.r * 0.92){
        e.hit = true;
        if(e.type === 'bomb'){
          game.lives -= 1;
          spawnJuice(e.x, e.y, '#ff6b6b', 36, 10);
          playBombExplode();
          showFloating('üí•', e.x, e.y, '#ffb3b3', 26);
          vibrate(160);
          entities.splice(i,1);
          if(game.lives <= 0){ setTimeout(()=> gameOver(), 150); }
        } else if(e.type === 'fruit'){
          hits++;
          if(e.meta && e.meta.special === 'gold'){
            game.score += Math.round(e.score || 60);
            spawnJuice(e.x, e.y, '#ffd86b', 64, 16);
            showFloating('üí∞ +'+Math.round(e.score||60), e.x, e.y, '#ffd86b', 18);
            playPop(1500, 0.12);
            Save.coins = (Save.coins||0) + 5;
            Save.achievements.gotGolden = (Save.achievements.gotGolden||0) + 1;
          } else if(e.meta && e.meta.special === 'slow'){
            game.score += Math.round(e.score || 20);
            spawnJuice(e.x, e.y, '#a8d6ff', 36, 12);
            showFloating('‚è≥ Slow!', e.x, e.y, '#a8d6ff', 16);
            startSlowMo(1800);
            playPop(1100, 0.12);
            Save.achievements.gotSlow = (Save.achievements.gotSlow||0)+1;
          } else {
            game.score += e.score || 10;
            spawnJuice(e.x, e.y, e.color || '#fff', 28, 8);
            playSwish();
          }
          splitToPieces(e);
          entities.splice(i,1);
        } else if(e.type === 'piece'){
          game.score += 3;
          spawnJuice(e.x, e.y, e.color||'#fff', 8,4);
          playPop(900, 0.06);
          entities.splice(i,1);
        }
      }
    }
  }
  if(hits > 1){
    const bonus = Math.round((hits-1) * 8 * Math.min(4, hits/2));
    game.score += bonus;
    showCombo(hits, bonus);
    Save.achievements.comboCount = (Save.achievements.comboCount||0) + 1;
  }
  // achievements: check score thresholds
  if(game.score >= 100 && !Save.achievements.score100){ Save.achievements.score100 = true; showToast('Achievement: 100 points!'); }
  if(Save.achievements.comboCount >= 5 && !Save.achievements.combo5){ Save.achievements.combo5 = true; showToast('Achievement: 5 combos!'); }
  saveAll();
  return hits;
}

/* ---------- floating text ---------- */
function showFloating(text,x,y,color='#fff',size=18){
  const el = document.createElement('div'); el.className = 'score-fx';
  el.style.left = (x / canvas.width * 100) + '%'; el.style.top = (y / canvas.height * 100) + '%';
  el.style.color = color; el.style.fontSize = `${size}px`; el.textContent = text;
  fxRoot.appendChild(el);
  const dur = 900;
  el.animate([{ transform:'translate(-50%,-50%) translateY(0px) scale(1)', opacity:1 }, { transform:'translate(-50%,-50%) translateY(-44px) scale(1.04)', opacity:0 }], { duration: dur, easing: 'cubic-bezier(.2,.8,.2,1)'});
  setTimeout(()=> el.remove(), dur+40);
}

/* ---------- combo popup ---------- */
function showCombo(n, bonus){
  comboPopup.textContent = 'üî• x' + n + ' Combo! +' + bonus;
  comboPopup.style.display = 'block';
  comboPopup.animate([{ transform:'translateX(-50%) scale(1)', opacity:1 }, { transform:'translateX(-50%) scale(1.14)', opacity:0 }], { duration:1000, easing:'cubic-bezier(.2,.8,.2,1)'});
  setTimeout(()=> comboPopup.style.display = 'none', 1000);
  playPop(1200 + n*80, 0.12);
}

/* ---------- slow motion ---------- */
let slowUntil = 0;
function startSlowMo(ms=1600){ slowUntil = Date.now() + ms; }

/* ---------- audio (WebAudio SFX) ---------- */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; } } }
function playSwish(){ if(!soundOn) return; ensureAudio(); if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.value = 900 + Math.random()*600; o.connect(g); g.connect(audioCtx.destination); const now = audioCtx.currentTime; g.gain.value=0.0001; g.gain.linearRampToValueAtTime(0.12, now+0.005); g.gain.exponentialRampToValueAtTime(0.0001, now+0.09); o.start(now); o.stop(now+0.11); }
function playPop(freq=520, dur=0.1){ if(!soundOn) return; ensureAudio(); if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.value=0.0001; g.gain.linearRampToValueAtTime(0.14, now+0.006); g.gain.exponentialRampToValueAtTime(0.0001, now+dur); o.start(now); o.stop(now+dur+0.02); }
function playBombExplode(){ if(!soundOn) return; ensureAudio(); if(!audioCtx) return; const b=audioCtx.createOscillator(); const gb=audioCtx.createGain(); b.type='sine'; b.frequency.value=140; b.connect(gb); gb.connect(audioCtx.destination); const now=audioCtx.currentTime; gb.gain.value=0.0001; gb.gain.linearRampToValueAtTime(0.18, now+0.012); gb.gain.exponentialRampToValueAtTime(0.0001, now+0.6); b.start(now); b.stop(now+0.64); }

/* ---------- vibration helper ---------- */
function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(e){} }

/* ---------- input handling ---------- */
let pointerDown = false;
const maxPath = 36;
function pushPointer(x,y){ game.path.push({x,y,t:Date.now()}); if(game.path.length > maxPath) game.path.shift(); }
function clearPath(){ game.path.length = 0; }
function getCanvasPos(e){
  const r = canvas.getBoundingClientRect();
  const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
  const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  return { x: (clientX - r.left) * dpr * (canvas.width / r.width), y: (clientY - r.top) * dpr * (canvas.height / r.height) };
}
canvas.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); pointerDown = true; resumeAudioOnInteraction(); const p = getCanvasPos(ev); pushPointer(p.x,p.y); });
canvas.addEventListener('pointermove', (ev)=>{ if(!pointerDown) return; const p = getCanvasPos(ev); pushPointer(p.x,p.y); });
canvas.addEventListener('pointerup', (ev)=>{ if(!pointerDown) return; pointerDown=false; const hits = processStroke(); if(hits === 1) playPop(840,0.06); clearPath(); });
canvas.addEventListener('pointercancel', ()=>{ pointerDown=false; clearPath(); });
canvas.addEventListener('contextmenu', e=>e.preventDefault());

/* ---------- game variables ---------- */
let entities = [];
let particles = [];
let game = { running:false, score:0, lives:3, level:1, lastSpawn:0, lastFrame: performance.now(), path:[] };
let raf = null;

/* ---------- render ---------- */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  // entities
  for(const e of entities) e.render(ctx, dpr);
  // particles
  for(const p of particles){
    ctx.beginPath(); ctx.globalAlpha = Math.max(0, 1 - p.t / p.life);
    ctx.fillStyle = p.color || '#fff'; ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
  }
  // swipe trail
  if(game.path.length > 1){
    ctx.save();
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    const g = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
    g.addColorStop(0,'rgba(255,255,255,0.12)'); g.addColorStop(1,'rgba(255,255,255,0.02)');
    ctx.strokeStyle = g; ctx.lineWidth = Math.max(6, dpr*3);
    ctx.beginPath(); ctx.moveTo(game.path[0].x, game.path[0].y);
    for(let i=1;i<game.path.length;i++) ctx.lineTo(game.path[i].x, game.path[i].y);
    ctx.stroke();
    ctx.globalCompositeOperation = 'lighter';
    ctx.strokeStyle = 'rgba(255,200,120,0.16)'; ctx.lineWidth = Math.max(12, dpr*6); ctx.stroke();
    ctx.restore();
  }
}

/* ---------- main loop ---------- */
function loop(now){
  const dt = Math.min(40, now - game.lastFrame);
  game.lastFrame = now;
  const slowFactor = (Date.now() < slowUntil) ? 0.52 : 1.0;

  if(game.running){
    const spawnMsBase = DIFF[difficulty].spawnMs;
    const spawnMs = spawnMsBase / spawnMultiplier;
    if(now - game.lastSpawn >= spawnMs){
      spawnEntity(); game.lastSpawn = now;
      if(game.score > 120 && Math.random() < Math.min(0.18, game.score/2400)) spawnEntity();
    }

    for(let i = entities.length - 1; i >= 0; i--){
      const e = entities[i];
      e.update(dt, slowFactor);
      if(e.type === 'piece' && e.life <= 0){ entities.splice(i,1); continue; }
      if(e.y > canvas.height + 160){
        if(e.type === 'fruit'){ game.lives -= 1; playPop(240,0.08); if(game.lives <= 0){ setTimeout(()=> gameOver(), 60); } }
        entities.splice(i,1);
      }
    }

    // particles
    for(let i = particles.length - 1; i >= 0; i--){
      const p = particles[i];
      p.t += dt; p.x += p.vx * (dt/16); p.y += p.vy * (dt/16); p.vy += 0.12 * (dt/16);
      if(p.t > p.life) particles.splice(i,1);
    }

    // level progression every 80 points
    const newLevel = Math.floor(game.score / 80) + 1;
    if(newLevel !== game.level){ game.level = newLevel; showToast('Level ' + game.level, 900); }

    // update UI elements
    document.getElementById('uiScore').textContent = game.score;
    document.getElementById('uiLives').textContent = game.lives;
    document.getElementById('uiLevel').textContent = game.level;
  }

  render();
  raf = requestAnimationFrame(loop);
}

/* ---------- start/reset/gameover ---------- */
const homeOpts = {
  difficulty: 'medium', sound: true
};

function startGame(){
  resumeAudioOnInteraction();
  overlayRoot.innerHTML = ''; overlayRoot.style.pointerEvents = 'none';
  entities.length = 0; particles.length = 0;
  game.running = true; game.score = 0; game.lives = 3; game.level = 1;
  game.path = []; game.lastFrame = performance.now(); game.lastSpawn = performance.now() - 150;
  spawnMultiplier = 1.0;
  if(!raf) raf = requestAnimationFrame(loop);
  showToast('Game started - ' + difficulty.toUpperCase());
}
function resetGame(){
  game.running = false; entities.length = 0; particles.length = 0;
  game.score = 0; game.lives = 3; game.level = 1;
  document.getElementById('uiScore').textContent = 0;
  showHomeOverlay();
}
function gameOver(){
  game.running = false;
  Save.coins = (Save.coins || 0) + Math.max(0, Math.round(game.score*0.12));
  if(game.score > Save.high){ Save.high = game.score; showToast('New Highscore! ' + Save.high, 1400); }
  saveAll();
  // show overlay
  overlayRoot.innerHTML = '';
  overlayRoot.style.pointerEvents = 'auto';
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h2>Game Over</h2>
    <div style="font-weight:900;font-size:20px">${game.score} pts</div>
    <div style="height:8px"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button class="btn primary" id="tryBtn">Play Again</button>
      <button class="btn" id="homeBtn">Home</button>
    </div>`;
  overlayRoot.appendChild(card);
  document.getElementById('tryBtn').addEventListener('click', ()=>{ overlayRoot.innerHTML = ''; overlayRoot.style.pointerEvents='none'; startGame(); });
  document.getElementById('homeBtn').addEventListener('click', ()=>{ overlayRoot.innerHTML=''; overlayRoot.style.pointerEvents='none'; showHomeOverlay(); });
}

/* ---------- home overlay (menu) ---------- */
function showHomeOverlay(){
  overlayRoot.innerHTML = ''; overlayRoot.style.pointerEvents = 'auto';
  const card = document.createElement('div'); card.className = 'card';
  loadSave();
  const ach = Save.achievements || {};
  card.innerHTML = `
    <div style="font-size:28px;margin-bottom:6px">üçì <strong>Fruit Pro ‚Äî Fury</strong></div>
    <div class="small">Highscore: <strong>${Save.high||0}</strong> &nbsp;&nbsp; Coins: <strong>${Save.coins||0}</strong></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px;justify-content:center"><button class="btn primary" id="playBtn">Play</button></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="small">Difficulty</div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost ${difficulty==='easy'?'active':''}" data-diff="easy">Easy</button>
        <button class="btn ghost ${difficulty==='medium'?'active':''}" data-diff="medium">Medium</button>
        <button class="btn ghost ${difficulty==='hard'?'active':''}" data-diff="hard">Hard</button>
      </div>
    </div>
    <div class="settings-row" style="margin-top:10px">
      <div class="small">Sound</div>
      <div><label class="toggle"><input type="checkbox" id="soundToggle" ${soundOn? 'checked':''}/> Sound</label></div>
    </div>
    <div style="height:12px"></div>
    <div class="small">Achievements</div>
    <div style="height:8px"></div>
    <div class="achievement-list">
      <div class="small">‚Ä¢ 100 points: ${ach.score100? '‚úÖ':'‚ùå'}</div>
      <div class="small">‚Ä¢ 5 combos: ${ach.combo5? '‚úÖ':'‚ùå'}</div>
      <div class="small">‚Ä¢ Golden fruit found: ${ach.gotGolden? (ach.gotGolden+' times') : '‚ùå'}</div>
    </div>
  `;
  overlayRoot.appendChild(card);
  document.getElementById('playBtn').addEventListener('click', ()=>{ overlayRoot.innerHTML=''; overlayRoot.style.pointerEvents='none'; startGame(); });
  // difficulty buttons
  card.querySelectorAll('button[data-diff]').forEach(b=>{
    b.addEventListener('click', ()=>{ difficulty = b.dataset.diff; showToast('Difficulty: ' + difficulty.toUpperCase()); card.querySelectorAll('button[data-diff]').forEach(x=>x.classList.remove('active')); b.classList.add('active'); });
  });
  document.getElementById('soundToggle').addEventListener('change', (e)=>{ soundOn = e.target.checked; showToast('Sound ' + (soundOn? 'On':'Off')); });
}

/* ---------- resume audio after user gesture ---------- */
function resumeAudioOnInteraction(){
  ensureAudio();
  if(audioCtx && audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); }
}

/* ---------- start RAF ---------- */
let entitiesInit = 0;
function init(){
  loadSave();
  showHomeOverlay();
  if(!raf) raf = requestAnimationFrame(loop);
}
init();

/* ---------- save on unload ---------- */
window.addEventListener('beforeunload', ()=>{ saveAll(); });

</script>
</body>
</html>
