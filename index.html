<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galaxy Shooter ‚Äî Ultra Fun</title>
<style>
:root{--accent:#7ef9ff;--accent2:#b388ff;--glass:rgba(255,255,255,0.06);}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:#000;font-family:Inter,system-ui,Arial;color:#eafcff;overflow:hidden}
#gameBox{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000}
canvas{display:block;width:100%;height:100%}
.hud{position:absolute;left:12px;top:12px;z-index:60;display:flex;gap:10px;align-items:center}
.chip{padding:8px 12px;border-radius:10px;background:var(--glass);border:2px solid rgba(255,255,255,0.06);font-weight:700}
.controls{position:absolute;right:12px;top:56px;display:flex;gap:10px;z-index:60}
.btn{padding:8px 10px;border-radius:12px;border:2px solid var(--accent);background:transparent;color:var(--accent);font-weight:700;cursor:pointer;transition:.12s}
.btn.secondary{border-color:var(--accent2);color:var(--accent2)}
.btn:active{transform:scale(.93);background:rgba(255,255,255,0.05)}
.mControls{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;z-index:50;pointer-events:none}
.circle{width:60px;height:60px;border-radius:50%;border:2px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;color:#fff;pointer-events:auto}
.fireBtn{width:72px;height:72px;border-radius:12px;border:2px solid var(--accent);background:transparent;pointer-events:auto;font-weight:800;color:var(--accent)}
#overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;pointer-events:none}
.menu{width:92%;max-width:720px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;pointer-events:auto;text-align:center;border:2px solid rgba(255,255,255,0.04)}
.hsmall{font-size:13px;color:#cbd5e1}
.topRow{display:flex;gap:10px;justify-content:center;margin-top:8px;flex-wrap:wrap}
.scoreList{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.scoreItem{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;font-size:13px}
#shopBox{margin-top:14px;text-align:left;font-size:13px;max-height:180px;overflow-y:auto}
.shopItem{border-radius:10px;border:1px solid rgba(255,255,255,0.05);padding:8px 10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.25)}
.shopItem strong{display:block;font-size:13px}
.shopDesc{opacity:.8}
.shopBtn{padding:6px 10px;border-radius:10px;border:2px solid var(--accent2);background:transparent;color:var(--accent2);font-size:12px;font-weight:700;cursor:pointer}
.shopBtn:active{transform:scale(.94);background:rgba(255,255,255,0.05)}
.joystick{position:absolute;left:14px;bottom:110px;width:140px;height:140px;border-radius:999px;z-index:70;pointer-events:auto;display:none;align-items:center;justify-content:center;opacity:.9}
.joyBase{width:110px;height:110px;border-radius:999px;background:rgba(255,255,255,0.02);border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center}
.joyKnob{width:48px;height:48px;border-radius:999px;background:rgba(126,249,255,0.08);border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:800}
@media(max-width:520px){.circle{width:52px;height:52px}.fireBtn{width:64px;height:64px}}
</style>
</head>
<body>
<div id="gameBox">
  <canvas id="game"></canvas>

  <div class="hud">
    <div class="chip" id="scoreUI">Score: 0</div>
    <div class="chip" id="levelUI">Level: 1</div>
    <div class="chip" id="livesUI">Lives: ‚ô•‚ô•‚ô•</div>
    <div class="chip" id="coinsUI">Coins: 0</div>
  </div>

  <div class="controls">
    <button class="btn" id="autoBtn">Auto: ON</button>
    <button class="btn" id="muteBtn">Mute</button>
    <button class="btn secondary" id="resetBtn">Reset</button>
  </div>

  <div class="mControls">
    <div style="display:flex;gap:10px;pointer-events:auto">
      <div class="circle" id="leftBtn"></div>
      <div class="circle" id="rightBtn"></div>
    </div>
    <div style="pointer-events:auto">
      <button class="fireBtn btn" id="fireBtn">FIRE</button>
    </div>
  </div>

  <!-- Virtual joystick -->
  <div class="joystick" id="joystick">
    <div class="joyBase" id="joyBase">
      <div class="joyKnob" id="joyKnob">‚óè</div>
    </div>
  </div>

  <div id="overlay">
    <div class="menu" id="menuPanel">
      <h2>Galaxy Shooter ‚Äî Ultra Fun</h2>
      <p class="hsmall">Fast bullets, quick bosses, more powerups. Swipe or joystick to move. Auto-fire ON by default. Coins unlock permanent upgrades in the shop.</p>

      <div class="topRow">
        <button class="btn" id="startBtn">Start Game</button>
        <button class="btn secondary" id="howBtn">How to Play</button>
        <button class="btn" id="toggleJoy">Joystick: OFF</button>
      </div>

      <div id="scoresBox" class="scoreList"></div>

      <h3 style="margin:10px 0 4px;font-size:15px">Shop (Permanent Upgrades)</h3>
      <div id="shopBox"></div>

      <div class="topRow" style="margin-top:8px">
        <button class="btn secondary" id="clearScores">Clear Scores</button>
        <button class="btn secondary" id="clearUpgrades">Reset Upgrades</button>
        <button class="btn" id="creditsBtn">Credits</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== canvas ===== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fit(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener('resize', fit); fit();

/* ===== images ===== */
const IMG = {};
const imageFiles = [
  {k:'player', src:'image/player.png'},
  {k:'bullet', src:'image/bullet.png'},
  {k:'enemy_small', src:'image/enemy_small.png'},
  {k:'enemy_medium', src:'image/enemy_medium.png'},
  {k:'enemy_large', src:'image/enemy_large.png'},
  {k:'powerup_double', src:'image/powerup_double.png'},
  {k:'powerup_life', src:'image/powerup_life.png'},
  {k:'powerup_power', src:'image/powerup_power.png'},
  {k:'powerup_rapid', src:'image/powerup_rapid.png'},
  {k:'powerup_shield', src:'image/powerup_shield.png'},
  {k:'boss', src:'image/boss.png'}
];
let loadedImages = 0;
imageFiles.forEach(f=>{
  const im = new Image();
  IMG[f.k] = im;
  im.onload = ()=>loadedImages++;
  im.onerror = ()=>{console.warn('img fail', f.src);loadedImages++;};
  im.src = f.src;
});

/* ===== audio ===== */
let audioCtx=null, muted=false, musicNode=null, musicGain=null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function sfx(freq=800,type='sine',dur=0.05,vol=0.06){
  if(muted || !audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+dur);
}
const playShoot = ()=>sfx(1100,'sine',0.03,0.04);
const playPickup = ()=>sfx(1500,'triangle',0.06,0.06);
const playExplode = ()=>sfx(220,'sawtooth',0.16,0.08);
const playBossHit = ()=>sfx(320,'square',0.08,0.08);
function startMusic(){
  if(musicNode || muted || !audioCtx) return;
  musicNode = audioCtx.createOscillator();
  musicGain = audioCtx.createGain();
  musicNode.type='sine'; musicNode.frequency.value=220;
  musicGain.gain.value=0.02;
  musicNode.connect(musicGain); musicGain.connect(audioCtx.destination);
  musicNode.start();
}
function stopMusic(){
  if(musicNode){ try{musicNode.stop();}catch(e){} musicNode.disconnect(); }
  if(musicGain) musicGain.disconnect();
  musicNode=null; musicGain=null;
}

/* ===== state ===== */
let running=false, paused=false, autoFire=true;
let score=0, level=1, lives=3, coins=0;
let bullets=[], enemies=[], pickups=[], particles=[];
let boss=null, bossSpawned=false, kills=0;
let lastTS=0, spawnTimer=0, waveTimer=0, waveIndex=0;
let autoTimer=null, joystickEnabled=false;

/* upgrades & scores */
let upgrades={power:0,maxLives:0,fireRate:0,shield:0};
let highScores=[];
const LS_SCORES='galaxy_scores_v3',LS_UP='galaxy_upgrades_v2',LS_COINS='galaxy_coins_v2';

function rand(a,b){return a+Math.random()*(b-a);}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function roundRect(ctx,x,y,w,h,r=6){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}

/* storage */
function loadScores(){try{const s=localStorage.getItem(LS_SCORES);highScores=s?JSON.parse(s):[];}catch(e){highScores=[];}}
function saveScores(){try{localStorage.setItem(LS_SCORES,JSON.stringify(highScores));}catch(e){}}
function addHighScore(v){highScores.push({score:v,date:Date.now()});highScores.sort((a,b)=>b.score-a.score);if(highScores.length>5)highScores.length=5;saveScores();renderScores();}
function renderScores(){
  const box=document.getElementById('scoresBox');box.innerHTML='';
  if(!highScores.length){box.innerHTML='<div class="scoreItem">No scores yet</div>';return;}
  highScores.forEach((s,i)=>{const d=new Date(s.date);const el=document.createElement('div');el.className='scoreItem';el.textContent=`${i+1}. ${s.score} ‚Äî ${d.toLocaleDateString()}`;box.appendChild(el);});
}
function loadUpgrades(){try{const u=localStorage.getItem(LS_UP);if(u)upgrades=JSON.parse(u);}catch(e){}}
function saveUpgrades(){try{localStorage.setItem(LS_UP,JSON.stringify(upgrades));}catch(e){}}
function loadCoins(){try{const c=localStorage.getItem(LS_COINS);coins=c?+c:0;}catch(e){coins=0;}}
function saveCoins(){try{localStorage.setItem(LS_COINS,String(coins));}catch(e){}}

/* HUD helpers */
function updateLives(){document.getElementById('livesUI').textContent='Lives: '+('‚ô•'.repeat(lives));}
function updateCoins(){document.getElementById('coinsUI').textContent='Coins: '+coins;}

/* shop */
const shopItems=[
 {id:'power',label:'Start Power +1',desc:'+1 base bullet power (max 4)',cost:120,max:4},
 {id:'maxLives',label:'Max Lives +1',desc:'+1 life at start (max +3)',cost:160,max:3},
 {id:'fireRate',label:'Fire Rate +',desc:'Faster base shooting',cost:140,max:4},
 {id:'shield',label:'Shield Boost',desc:'+1 shield hit from shield pickup',cost:120,max:3}
];
function renderShop(){
  const box=document.getElementById('shopBox');box.innerHTML='';
  shopItems.forEach(it=>{
    const lvl=upgrades[it.id]||0;
    const row=document.createElement('div');row.className='shopItem';
    const info=document.createElement('div');
    info.innerHTML=`<strong>${it.label} (Lv ${lvl}/${it.max})</strong><span class="shopDesc">${it.desc}</span>`;
    const btn=document.createElement('button');btn.className='shopBtn';
    btn.textContent=lvl>=it.max?'MAX':`Buy ${it.cost}üí∞`;
    btn.disabled=lvl>=it.max;
    btn.onclick=()=>buyUpgrade(it);
    row.appendChild(info);row.appendChild(btn);box.appendChild(row);
  });
}
function buyUpgrade(it){
  const lvl=upgrades[it.id]||0;
  if(lvl>=it.max)return;
  if(coins<it.cost){alert('Not enough coins');return;}
  coins-=it.cost;upgrades[it.id]=lvl+1;
  saveUpgrades();saveCoins();updateCoins();renderShop();
}

/* player */
const player={
  x:canvas.width/2-48,
  y:canvas.height-160,
  w:96,h:96,speed:7,
  tx:null,ty:null,
  cooldown:0,baseFireRate:180,fireRate:180, // faster than before
  bulletPower:2,double:false,shield:0,alive:true
};

/* shooting */
function shoot(){
  if(!running||paused||!player.alive)return;
  const now=performance.now();
  if(now-player.cooldown<player.fireRate)return;
  player.cooldown=now;
  const size=10+Math.min(player.bulletPower-1,10)*3;
  const dmg=Math.max(1,Math.floor(player.bulletPower/2));
  bullets.push({x:player.x+player.w/2,y:player.y+8,w:size,h:size*1.6,vy:-13,dmg,img:IMG.bullet,hostile:false});
  // always small side bullets for more fun
  bullets.push({x:player.x+18,y:player.y+10,w:size*0.8,h:size*1.3,vy:-12,dmg,img:IMG.bullet,hostile:false});
  bullets.push({x:player.x+player.w-18,y:player.y+10,w:size*0.8,h:size*1.3,vy:-12,dmg,img:IMG.bullet,hostile:false});
  if(player.double){
    bullets.push({x:player.x+player.w/2-10,y:player.y+4,w:size*0.8,h:size*1.3,vy:-13,dmg,img:IMG.bullet,hostile:false});
    bullets.push({x:player.x+player.w/2+10,y:player.y+4,w:size*0.8,h:size*1.3,vy:-13,dmg,img:IMG.bullet,hostile:false});
  }
  playShoot();
}
function setupAuto(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;}
  if(autoFire)autoTimer=setInterval(()=>{if(running&&!paused)shoot();},Math.max(40,Math.round(player.fireRate*0.6)));
}

/* waves & boss */
function killTarget(){return 25+(level-1)*10;} // faster boss
function spawnWave(type,count){
  if(type==='v'){
    const c=canvas.width/2;
    for(let i=0;i<count;i++){
      const off=(i-Math.floor(count/2))*70;
      enemies.push({x:c+off,y:-100-i*30,w:72,h:96,vy:1.8+Math.random()*0.5,hp:1,img:IMG.enemy_small,score:2});
    }
  }else if(type==='line'){
    const sp=Math.max(70,Math.floor(canvas.width/count)-10);
    for(let i=0;i<count;i++)
      enemies.push({x:40+i*sp,y:-80,w:80,h:110,vy:1.6+Math.random()*0.5,hp:1,img:IMG.enemy_small,score:2});
  }else if(type==='circle'){
    const cx=canvas.width/2,cy=-40;
    for(let i=0;i<count;i++){
      const a=i/count*Math.PI*2;
      enemies.push({x:cx+Math.cos(a)*170,y:cy+Math.sin(a)*70-80,w:96,h:120,vy:1.3+Math.random()*0.6,hp:2,img:IMG.enemy_medium,score:3});
    }
  }else{
    for(let i=0;i<count;i++){
      const r=Math.random();
      if(r<0.65)enemies.push({x:rand(40,canvas.width-80),y:-40-i*20,w:72,h:96,vy:1.9+Math.random()*0.5,hp:1,img:IMG.enemy_small,score:2});
      else if(r<0.9)enemies.push({x:rand(60,canvas.width-140),y:-60-i*20,w:100,h:130,vy:1.5+Math.random()*0.6,hp:2,img:IMG.enemy_medium,score:4});
      else enemies.push({x:rand(80,canvas.width-200),y:-90-i*30,w:140,h:170,vy:1.2+Math.random()*0.5,hp:4,img:IMG.enemy_large,score:6});
    }
  }
}
function spawnBoss(){
  boss={
    x:canvas.width/2-200,y:-260,
    w:400,h:260,vy:0.9,
    hp:220+(level-1)*60,maxHp:220+(level-1)*60,
    phase:1,timer:0,
    img:(IMG.boss&&IMG.boss.complete)?IMG.boss:null
  };
  bossSpawned=true;
}

/* pickups (drop rate zyada) */
function dropPickup(x,y){
  const r=Math.random(); let kind;
  if(r<0.24)kind='powerup_power';
  else if(r<0.48)kind='powerup_rapid';
  else if(r<0.72)kind='powerup_double';
  else if(r<0.88)kind='powerup_shield';
  else kind='powerup_life';
  pickups.push({x,y,w:38,h:38,vy:1.3,kind,img:IMG[kind]});
}
function collectPickup(p){
  if(p.kind==='powerup_double'){player.double=true;setTimeout(()=>player.double=false,10000);}
  if(p.kind==='powerup_power'){player.bulletPower=Math.min(20,player.bulletPower+1);}
  if(p.kind==='powerup_rapid'){const prev=player.fireRate;player.fireRate=Math.max(50,player.fireRate-70);setTimeout(()=>player.fireRate=prev,9000);}
  if(p.kind==='powerup_shield'){player.shield=(player.shield||0)+1+(upgrades.shield||0);}
  if(p.kind==='powerup_life'){lives=Math.min(6,lives+1);updateLives();}
  playPickup();
  for(let i=0;i<8;i++)particles.push({x:p.x,y:p.y,vx:rand(-2,2),vy:rand(-4,0),life:rand(20,50),size:rand(1,3),col:'#9fffb6'});
}

/* swipe controls */
let pointerDown=false;
function getPointerPos(e){
  const r=canvas.getBoundingClientRect();
  let cx=e.clientX,cy=e.clientY;
  if(e.touches&&e.touches[0]){cx=e.touches[0].clientX;cy=e.touches[0].clientY;}
  if(cx==null)return null;
  return {x:(cx-r.left)/r.width*canvas.width,y:(cy-r.top)/r.height*canvas.height};
}
function onPointerDown(e){pointerDown=true;const p=getPointerPos(e);if(!p)return;player.tx=clamp(p.x-player.w/2,8,canvas.width-player.w-8);player.ty=clamp(p.y-player.h/2,8,canvas.height-player.h-8);}
function onPointerMove(e){if(!pointerDown)return;const p=getPointerPos(e);if(!p)return;player.tx=clamp(p.x-player.w/2,8,canvas.width-player.w-8);player.ty=clamp(p.y-player.h/2,8,canvas.height-player.h-8);}
function onPointerUp(){pointerDown=false;}
canvas.addEventListener('pointerdown',onPointerDown);
canvas.addEventListener('pointermove',onPointerMove);
canvas.addEventListener('pointerup',onPointerUp);
canvas.addEventListener('touchstart',onPointerDown,{passive:false});
canvas.addEventListener('touchmove',onPointerMove,{passive:false});
canvas.addEventListener('touchend',onPointerUp,{passive:false});

/* joystick */
const joy=document.getElementById('joystick');
const joyBase=document.getElementById('joyBase');
const joyKnob=document.getElementById('joyKnob');
let joyActive=false;
function enableJoystick(on){joystickEnabled=on;joy.style.display=on?'flex':'none';document.getElementById('toggleJoy').textContent='Joystick: '+(on?'ON':'OFF');}
function joyDown(e){if(!joystickEnabled)return;joyActive=true;moveKnob(e);}
function joyMove(e){if(!joyActive)return;moveKnob(e);}
function joyUp(){joyActive=false;joyKnob.style.transform='translate(0,0)';player.tx=null;player.ty=null;}
function moveKnob(e){
  const r=joy.getBoundingClientRect();
  let cx=e.clientX||(e.touches&&e.touches[0].clientX);
  let cy=e.clientY||(e.touches&&e.touches[0].clientY);
  if(cx==null)return;
  const localX=cx-r.left-r.width/2;
  const localY=cy-r.top-r.height/2;
  const max=r.width/2-12;
  const dx=clamp(localX,-max,max),dy=clamp(localY,-max,max);
  joyKnob.style.transform=`translate(${dx}px,${dy}px)`;
  const moveX=dx/max*6*player.speed,moveY=dy/max*6*player.speed;
  player.tx=clamp(player.x+moveX,8,canvas.width-player.w-8);
  player.ty=clamp(player.y+moveY,8,canvas.height-player.h-8);
}
joyBase.addEventListener('pointerdown',joyDown);
addEventListener('pointermove',joyMove);
addEventListener('pointerup',joyUp);
joyBase.addEventListener('touchstart',joyDown,{passive:false});
addEventListener('touchmove',joyMove,{passive:false});
addEventListener('touchend',joyUp,{passive:false});

/* keyboard + LR */
const keys={};
addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Space')shoot();if(e.code==='KeyP')togglePause();});
addEventListener('keyup',e=>{keys[e.code]=false;});
document.getElementById('leftBtn').addEventListener('pointerdown',()=>keys['ArrowLeft']=true);
document.getElementById('leftBtn').addEventListener('pointerup',()=>keys['ArrowLeft']=false);
document.getElementById('rightBtn').addEventListener('pointerdown',()=>keys['ArrowRight']=true);
document.getElementById('rightBtn').addEventListener('pointerup',()=>keys['ArrowRight']=false);

/* buttons */
document.getElementById('startBtn').onclick=()=>{if(loadedImages<imageFiles.length&&!confirm('Images still loading ‚Äî start anyway?'))return;startGame();};
document.getElementById('howBtn').onclick=()=>alert('Move: swipe / joystick / arrows.\nAuto-fire ON (button se OFF kar sakte ho).\nPowerups: power, rapid, double, shield, life.\nHar level me thode kills ke baad boss aaye‡§ó‡§æ.');
document.getElementById('toggleJoy').onclick=()=>enableJoystick(!joystickEnabled);
document.getElementById('autoBtn').onclick=()=>{autoFire=!autoFire;document.getElementById('autoBtn').textContent='Auto: '+(autoFire?'ON':'OFF');setupAuto();};
document.getElementById('muteBtn').onclick=()=>{
  muted=!muted;document.getElementById('muteBtn').textContent=muted?'Unmute':'Mute';
  if(muted){if(audioCtx)audioCtx.suspend();stopMusic();}else{ensureAudio();audioCtx.resume();if(running)startMusic();}
};
document.getElementById('resetBtn').onclick=()=>location.reload();
document.getElementById('fireBtn').onclick=shoot;
document.getElementById('clearScores').onclick=()=>{if(confirm('Clear saved scores?')){highScores=[];saveScores();renderScores();}};
document.getElementById('clearUpgrades').onclick=()=>{if(confirm('Reset upgrades?')){upgrades={power:0,maxLives:0,fireRate:0,shield:0};saveUpgrades();renderShop();}};
document.getElementById('creditsBtn').onclick=()=>alert('Galaxy Shooter Ultra Fun ‚Äî HTML5 game\nSprites from your image folder; progress saved in this browser.');

/* update */
function update(dt){
  if(!running||paused)return;

  if(player.tx!=null&&player.ty!=null){
    player.x+=(player.tx-player.x)*0.22;
    player.y+=(player.ty-player.y)*0.22;
  }else{
    if(keys['ArrowLeft']||keys['KeyA'])player.x-=player.speed;
    if(keys['ArrowRight']||keys['KeyD'])player.x+=player.speed;
    if(keys['ArrowUp']||keys['KeyW'])player.y-=player.speed;
    if(keys['ArrowDown']||keys['KeyS'])player.y+=player.speed;
  }
  player.x=clamp(player.x,8,canvas.width-player.w-8);
  player.y=clamp(player.y,8,canvas.height-player.h-8);

  spawnTimer+=dt; waveTimer+=dt;
  if(waveTimer>Math.max(3500,7000-level*350)){
    waveTimer=0;
    const types=['v','line','circle','swarm'];
    spawnWave(types[waveIndex%types.length],6+Math.floor(level/2));
    waveIndex++;
  }
  if(!boss && spawnTimer>Math.max(400,900-level*30)){
    spawnTimer=0;
    spawnWave('swarm',3+Math.floor(level/3));
  }
  if(!bossSpawned && kills>=killTarget())spawnBoss();

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.y+=b.vy;
    if(b.y<-80||b.y>canvas.height+200)bullets.splice(i,1);
  }

  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.y+=e.vy; e.x+=Math.sin((performance.now()/400)+e.x)*0.25;
    for(let bi=bullets.length-1;bi>=0;bi--){
      const b=bullets[bi]; if(b.hostile)continue;
      const bx=b.x-b.w/2,by=b.y-b.h/2;
      if(!(bx+b.w<e.x||bx>e.x+e.w||by+b.h<e.y||by>e.y+e.h)){
        e.hp-=b.dmg||1; bullets.splice(bi,1);
        if(e.hp<=0){
          score+=e.score||1; coins+=e.score||1; kills++;
          dropPickup(e.x+e.w/2,e.y+e.h/2);
          for(let p=0;p<8;p++)particles.push({x:e.x+e.w/2,y:e.y+e.h/2,vx:rand(-2,2),vy:rand(-4,1),life:rand(20,60),size:rand(1,3),col:'#ff9b9b'});
          enemies.splice(i,1);
        }
        break;
      }
    }
    if(e.y>canvas.height+120)enemies.splice(i,1);
  }

  if(boss){
    boss.timer+=dt; boss.y+=boss.vy;
    boss.x+=Math.sin(boss.timer/600)*(boss.phase===1?1.3:3.0);
    boss.x=clamp(boss.x,20,canvas.width-boss.w-20);
    if(boss.phase===1){
      if(boss.timer>900){
        boss.timer=0;
        for(let k=-2;k<=2;k++)bullets.push({x:boss.x+boss.w/2+k*30,y:boss.y+boss.h,vy:3.4+Math.abs(k)*0.3,w:12,h:16,hostile:true});
        playBossHit();
      }
    }else{
      if(boss.timer>650){
        boss.timer=0;
        for(let k=-1;k<=1;k++)bullets.push({x:boss.x+boss.w/2+k*42,y:boss.y+boss.h,vy:4.8,w:12,h:16,hostile:true});
        for(let j=0;j<2;j++)enemies.push({x:boss.x+rand(40,boss.w-40),y:boss.y+boss.h+8,w:72,h:96,vy:2.3,hp:1,img:IMG.enemy_small,score:2});
        playBossHit();
      }
    }
    for(let bi=bullets.length-1;bi>=0;bi--){
      const b=bullets[bi]; if(b.hostile)continue;
      const bx=b.x-b.w/2,by=b.y-b.h/2;
      if(!(bx+b.w<boss.x||bx>boss.x+boss.w||by+b.h<boss.y||by>boss.y+boss.h)){
        boss.hp-=b.dmg||1; bullets.splice(bi,1); playBossHit();
        if(boss.phase===1 && boss.hp<boss.maxHp*0.5)boss.phase=2;
        if(boss.hp<=0){
          for(let p=0;p<120;p++)particles.push({x:boss.x+boss.w/2,y:boss.y+boss.h/2,vx:rand(-8,8),vy:rand(-8,4),life:rand(40,110),size:rand(2,6),col:'#ffd27e'});
          score+=400+level*30; coins+=100+level*30;
          boss=null; bossSpawned=false; kills=0; level++; playExplode();
        }
        break;
      }
    }
  }

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; if(!b.hostile)continue;
    const bx=b.x-b.w/2,by=b.y-b.h/2;
    if(!(bx+b.w<player.x||bx>player.x+player.w||by+b.h<player.y||by>player.y+player.h)){
      bullets.splice(i,1);
      if(player.shield>0)player.shield--;
      else{lives--;updateLives();if(lives<=0){player.alive=false;running=false;endRun();return;}}
    }
  }

  for(let i=pickups.length-1;i>=0;i--){
    const p=pickups[i]; p.y+=p.vy;
    if(Math.abs((player.x+player.w/2)-p.x)<36 && Math.abs((player.y+player.h/2)-p.y)<36){collectPickup(p);pickups.splice(i,1);continue;}
    if(p.y>canvas.height+80)pickups.splice(i,1);
  }

  for(let i=particles.length-1;i>=0;i--){
    const pt=particles[i]; pt.x+=pt.vx; pt.y+=pt.vy; pt.vy+=0.12; pt.life--; if(pt.life<=0)particles.splice(i,1);
  }

  document.getElementById('scoreUI').textContent='Score: '+score;
  document.getElementById('levelUI').textContent='Level: '+level;
  updateCoins();
}

/* draw */
function draw(){
  const g=ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'#000814');g.addColorStop(1,'#001028');
  ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle='#fff';
  for(let i=0;i<60;i++){
    const x=(i*73+performance.now()/10*(i%3+1))%canvas.width;
    const y=((i*31)+performance.now()/200*(i%4+1))%canvas.height;
    ctx.globalAlpha=0.6-(i%5)*0.07;
    ctx.fillRect(x,y,2,2);
  }
  ctx.globalAlpha=1;

  const bob=Math.sin(performance.now()/240)*4;
  ctx.save();ctx.translate(player.x+player.w/2,player.y+player.h/2+bob);ctx.rotate(Math.sin(performance.now()/200)/20);
  if(IMG.player&&IMG.player.complete&&IMG.player.naturalWidth)ctx.drawImage(IMG.player,-player.w/2,-player.h/2,player.w,player.h);
  else{ctx.fillStyle='#bfefff';ctx.beginPath();ctx.moveTo(-player.w/2+10,player.h/2-8);ctx.lineTo(0,-player.h/2);ctx.lineTo(player.w/2-10,player.h/2-8);ctx.closePath();ctx.fill();}
  ctx.restore();

  if(player.shield>0){
    ctx.save();ctx.beginPath();ctx.arc(player.x+player.w/2,player.y+player.h/2,Math.max(player.w,player.h)/1.1,0,Math.PI*2);
    ctx.strokeStyle='rgba(150,255,220,0.18)';ctx.lineWidth=6;ctx.stroke();ctx.restore();
  }

  for(const b of bullets){
    if(b.img&&b.img.complete&&b.img.naturalWidth)ctx.drawImage(b.img,b.x-b.w/2,b.y-b.h/2,b.w,b.h);
    else{ctx.fillStyle=b.hostile?'#ff9b9b':'#aefcff';roundRect(ctx,b.x-b.w/2,b.y-b.h/2,b.w,b.h,4);ctx.fill();}
  }

  for(const e of enemies){
    if(e.img&&e.img.complete&&e.img.naturalWidth)ctx.drawImage(e.img,e.x,e.y,e.w,e.h);
    else{ctx.fillStyle='#ff8b7f';roundRect(ctx,e.x,e.y,e.w,e.h,8);ctx.fill();}
  }

  for(const p of pickups){
    if(p.img&&p.img.complete&&p.img.naturalWidth)ctx.drawImage(p.img,p.x-p.w/2,p.y-p.h/2,p.w,p.h);
    else{ctx.beginPath();ctx.fillStyle='#9fffb6';ctx.arc(p.x,p.y,p.w/2,0,Math.PI*2);ctx.fill();}
  }

  if(boss){
    if(boss.img&&boss.img.complete&&boss.img.naturalWidth)ctx.drawImage(boss.img,boss.x,boss.y,boss.w,boss.h);
    else{ctx.fillStyle=boss.phase===1?'#ffaa66':'#ff6b6b';roundRect(ctx,boss.x,boss.y,boss.w,boss.h,12);ctx.fill();}
    ctx.fillStyle='rgba(255,255,255,0.06)';roundRect(ctx,boss.x+20,boss.y+boss.h+8,boss.w-40,10,6);ctx.fill();
    ctx.fillStyle='#7ef9ff';roundRect(ctx,boss.x+20,boss.y+boss.h+8,(boss.w-40)*Math.max(0,boss.hp/boss.maxHp),10,6);ctx.fill();
  }

  for(const pt of particles){
    ctx.fillStyle=pt.col||'#fff';
    ctx.globalAlpha=Math.max(0,Math.min(1,pt.life/80));
    ctx.fillRect(pt.x,pt.y,pt.size,pt.size);
  }
  ctx.globalAlpha=1;
}

/* loop */
let raf=null;
function loop(ts){
  if(!running||paused){raf=requestAnimationFrame(loop);return;}
  if(!lastTS)lastTS=ts;
  const dt=Math.min(45,ts-lastTS);
  lastTS=ts;
  update(dt);draw();
  raf=requestAnimationFrame(loop);
}

/* start / end */
function startGame(){
  ensureAudio();startMusic();
  bullets=[];enemies=[];pickups=[];particles=[];
  boss=null;bossSpawned=false;kills=0;
  score=0;level=1;
  lives=3+(upgrades.maxLives||0);updateLives();
  player.bulletPower=2+(upgrades.power||0); // OP start
  player.baseFireRate=180-Math.min((upgrades.fireRate||0)*20,100);
  player.fireRate=player.baseFireRate;
  player.double=false;player.shield=0;player.alive=true;
  player.x=canvas.width/2-player.w/2;player.y=canvas.height-player.h-60;
  document.getElementById('overlay').style.display='none';
  running=true;paused=false;
  setupAuto();
  lastTS=performance.now();loop(lastTS);
}
function togglePause(){paused=!paused;if(!paused){lastTS=performance.now();loop(lastTS);}}
function endRun(){
  saveCoins();addHighScore(score);
  document.getElementById('overlay').style.display='flex';
  document.getElementById('menuPanel').querySelector('h2').textContent='Game Over ‚Äî Score: '+score;
  stopMusic();
}

/* init storage & HUD */
function init(){
  loadScores();renderScores();
  loadUpgrades();renderShop();
  loadCoins();updateCoins();updateLives();
  document.getElementById('autoBtn').textContent='Auto: '+(autoFire?'ON':'OFF');
}
init();

/* unlock audio */
document.addEventListener('touchstart',()=>ensureAudio(),{once:true});
document.addEventListener('mousedown',()=>ensureAudio(),{once:true});

document.getElementById('overlay').style.display='flex';
</script>
</body>
</html>
