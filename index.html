<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fruit Cut ‚Äî Final All-in-One</title>
<style>
:root{
  --ui:#f4f7fb; --panel:#efe9e1; --btn:#111; --accent:#22c55e;
  --hud-shadow: 0 8px 22px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--ui);font-family:Inter,system-ui,Roboto,Arial,sans-serif;color:#111}
.container{max-width:920px;margin:0 auto;padding:12px}
h1{text-align:center;margin:8px 0}
.hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
.stat{background:#fff;padding:8px 12px;border-radius:12px;box-shadow:var(--hud-shadow);font-weight:700}
#gameWrapper{position:relative;border-radius:14px;overflow:hidden;height:66vh;min-height:480px;background:linear-gradient(180deg,#bfe9ff,#f6f7fb)}
#sky{position:absolute;inset:0;z-index:1}
#gameArea{position:absolute;inset:0;z-index:2;touch-action:none}
canvas{position:absolute;inset:0;z-index:6;pointer-events:none}
.fruit, .half{position:absolute;transform:translate(-50%,-50%);user-select:none;pointer-events:none;z-index:5}
#bigStart{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:12;background:var(--btn);color:#fff;padding:14px 20px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 12px 34px rgba(0,0,0,0.25)}
.controls{display:flex;gap:12px;justify-content:center;padding:18px;margin-top:6px}
.btn{background:#fff;border:0;padding:10px 18px;border-radius:12px;cursor:pointer;box-shadow:0 10px 26px rgba(2,6,23,0.06);font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
#gameOver{position:absolute;inset:0;z-index:1400;display:none;align-items:center;justify-content:center}
.card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 12px 36px rgba(2,6,23,0.12)}
.modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1500;display:none}
.shopGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.shopItem{background:#fff;padding:8px;border-radius:8px;display:flex;align-items:center;gap:8px;justify-content:space-between}
.thumb{width:64px;height:44px;object-fit:cover;border-radius:8px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.8);color:#fff;padding:8px 14px;border-radius:999px;z-index:1600;display:none}
.loadingOverlay{position:absolute;inset:0;background:rgba(255,255,255,0.9);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.progress{width:70%;max-width:420px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 12px 36px rgba(0,0,0,0.08);text-align:center}
.progressBar{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin:10px 0}
.progressFill{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#06b6d4)}
.loadingEmoji{font-size:42px}
.hidden{display:none}
.small{font-size:13px;color:#666}
@media (max-width:720px){ #gameWrapper{height:62vh;min-height:420px} .thumb{width:56px;height:40px} }
</style>
</head>
<body>
<div class="container">
  <h1>üçâ Fruit Cut ‚Äî Final </h1>

  <div class="hud">
    <div class="stat">Score: <strong id="score">0</strong></div>
    <div class="stat">Lives: <strong id="lives">3</strong></div>
    <div class="stat">Coins: <strong id="coins">0</strong></div>
    <div style="flex:1"></div>
    <div class="stat">Level: <strong id="level">1</strong></div>
  </div>

  <div id="gameWrapper">
    <div id="sky"></div>
    <div id="gameArea" aria-label="game area"></div>
    <canvas id="bladeCanvas"></canvas>
    <canvas id="particles"></canvas>

    <div class="loadingOverlay" id="loader">
      <div class="progress">
        <div class="loadingEmoji" id="loadEmoji">üçâ</div>
        <div id="loadText">Loading images...</div>
        <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
        <div class="small" id="progressCount">0 / 0</div>
      </div>
    </div>

    <div id="bigStart">START</div>

    <div id="gameOver">
      <div class="card" style="text-align:center">
        <h2>Game Over</h2>
        <p>Score: <strong id="goScore">0</strong></p>
        <p>Best: <strong id="goBest">0</strong></p>
        <div style="margin-top:12px">
          <button id="goRestart" class="btn">Play Again</button>
        </div>
      </div>
    </div>
<!-- Shop modal -->
    <div id="shopModal" class="modal">
      <div class="card" style="min-width:320px;max-width:92vw">
        <h3 style="margin:0 0 8px">Shop ‚Äî Buy Backgrounds / Blades</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <div class="small">Coins: <strong id="shopCoins">0</strong></div>
          <div style="flex:1"></div>
          <button id="closeShop" class="btn">Close</button>
        </div>

        <div style="margin-top:6px"><strong>Backgrounds</strong></div>
        <div class="shopGrid" id="bgGrid" style="margin:8px 0"></div>

        <div style="margin-top:6px"><strong>Blade skins</strong></div>
        <div class="shopGrid" id="bladeGrid" style="margin:8px 0"></div>
      </div>
    </div>

  </div>

  <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
    <button id="startBtn" class="btn">Start</button>
    <button id="pauseBtn" class="btn">Pause</button>
    <button id="restartBtn" class="btn">Restart</button>
    <button id="shopBtn" class="btn">Shop</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* FINAL ALL-IN-ONE: Game + Preload + Shop + Save
   Put fruit images in images/ folder. Use filenames in FRUITS+ BOMB arrays below.
*/
  }

  function applyBackground(bgId){
    const bg = BACKGROUNDS.find(b=>b.id===bgId) || BACKGROUNDS[0];
    document.getElementById('gameWrapper').style.background = bg.css;
    shopState.selectedBg = bg.id;
    saveShop();
  }

  // map blade data for quick access
  const BLADES_MAP = {};
  BLADES.forEach(b=>BLADES_MAP[b.id]=b);

  // === INIT & BINDINGS ===
  startBtn.addEventListener('click', ()=> startGame(false));
  bigStart.addEventListener('click', ()=> startGame(false));
  pauseBtn.addEventListener('click', ()=> pauseGame());
  restartBtn.addEventListener('click', ()=> restartGame());
  shopBtn.addEventListener('click', ()=> openShop());
  closeShop.addEventListener('click', ()=> closeShopModal());
  goRestart.addEventListener('click', ()=> { gameOver.style.display='none'; restartGame(); });

  // pointer listeners
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerdown', onPointerMove);
  window.addEventListener('pointerup', ()=> bladePoints = []);

  // resize on load
  function init(){
    resize(); physicsTick();
    // show loader and start emoji
    loader.style.display = 'flex'; startEmoji();
    preloadImages(2400).then(() => {
      stopEmoji();
      loader.style.display = 'none';
      // apply saved shop state / coins
      coins = shopState.coins || coins;
      updateHUD();
      updateShopUI();
      // auto start after small delay
      setTimeout(()=>{ if(!running){ startGame(true); } }, 300);
    });
  }

  // pointer move handler (defined earlier). Ensure area rect on load
  function initBindings(){ /* already bound */ }

  // start emoji helper
  function startEmoji(){ let i=0; loadEmoji.textContent = EMOJIS[0]; if(!window._emojiInterval){ window._emojiInterval = setInterval(()=>{ i=(i+1)%EMOJIS.length; loadEmoji.textContent = EMOJIS[i]; }, 600); } }
  function stopEmoji(){ if(window._emojiInterval){ clearInterval(window._emojiInterval); window._emojiInterval = null; } }

  // physics & drawing tick loop already defined as physicsTick but need to call update/draw inside
  function physicsTick(){ if(running && !paused){ update(); draw(); } requestAnimationFrame(physicsTick); }

  // preload wrapper already defined; update loader counts
  // modify preloadImages to update progress display (done above)

  // Start everything when page load
  window.addEventListener('load', init);

  // Expose small API for debugging (hidden by default)
  window.FruitCut = { start: ()=>startGame(false), pause: ()=>pauseGame(), restart: ()=>restartGame(), shop: ()=>openShop() };

  // initial HUD
  updateHUD();

  // small convenience: ensure shopState default purchases include free items
  BACKGROUNDS.forEach(b => { if(b.cost===0 && !shopState.purchasedBackgrounds.includes(b.id)) shopState.purchasedBackgrounds.push(b.id); });
  BLADES.forEach(b => { if(b.cost===0 && !shopState.purchasedBlades.includes(b.id)) shopState.purchasedBlades.push(b.id); });

})();
</script>
</body>
</html>
