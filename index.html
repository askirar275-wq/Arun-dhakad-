<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enhanced 3D Racing Game</title>
<style>
body{margin:0; overflow:hidden; background:#87ceeb;}
canvas{display:block;}
#ui{position:absolute; top:10px; width:100%; text-align:center; font-family:sans-serif; color:#fff; font-size:18px; text-shadow:1px 1px 3px #000;}
#score{position:absolute; top:40px; width:100%; text-align:center; font-size:20px;}
#combo{position:absolute; top:70px; width:100%; text-align:center; font-size:18px;}
button{position:absolute; bottom:20px; left:50%; transform:translateX(-50%); padding:12px 24px; font-size:16px; border:2px solid #fff; background:rgba(255,255,255,0.1); color:#fff; border-radius:10px; cursor:pointer; transition:all 0.3s ease;}
button:hover{background:rgba(255,255,255,0.3);}
button:active{transform:translateX(-50%) scale(0.95);}
</style>
</head>
<body>
<div id="ui">Enhanced 3D Racing Game</div>
<div id="score">Score: 0</div>
<div id="combo">Combo: 0</div>
<button onclick="speedBoost()">Boost!</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
let scene, camera, renderer, car;
let road, trees=[], coins=[], obstacles=[];
let speed=0.15, boostSpeed=0.35, laneWidth=2;
let moveLeft=false, moveRight=false;
let score=0, combo=0, comboTimer;
let boostActive=false;

// Scene & Camera
scene=new THREE.Scene(); scene.background=new THREE.Color(0x87ceeb);
camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);
camera.position.set(0,5,10); camera.lookAt(0,0,0);

// Renderer
renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lights
scene.add(new THREE.AmbientLight(0xffffff,0.7));
let directionalLight=new THREE.DirectionalLight(0xffffff,0.7);
directionalLight.position.set(5,10,7.5);
scene.add(directionalLight);

// Ground
const ground=new THREE.Mesh(new THREE.PlaneGeometry(50,200), new THREE.MeshPhongMaterial({color:0x228B22}));
ground.rotation.x=-Math.PI/2; scene.add(ground);

// Road
road=new THREE.Mesh(new THREE.PlaneGeometry(6,200), new THREE.MeshPhongMaterial({color:0x333333}));
road.position.y=0.01; road.rotation.x=-Math.PI/2; scene.add(road);

// Trees
function addTree(x,z){ 
  const trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.5,2,8), new THREE.MeshPhongMaterial({color:0x8B4513}));
  const leaves=new THREE.Mesh(new THREE.ConeGeometry(1,2,8), new THREE.MeshPhongMaterial({color:0x228B22}));
  trunk.position.set(x,1,z); leaves.position.set(x,3,z);
  scene.add(trunk); scene.add(leaves); trees.push({trunk,leaves});
}
for(let i=0;i<20;i++){ addTree(-5,i*10); addTree(5,i*10+5); }

// Coins
function addCoin(x,z){
  const coin=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,0.05,16), new THREE.MeshPhongMaterial({color:0xFFD700}));
  coin.position.set(x,0.25,z); scene.add(coin); coins.push(coin);
}
for(let i=5;i<200;i+=15){ addCoin(-1,i); addCoin(1,i+7); }

// Obstacles
function addObstacle(x,z){
  const obs=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshPhongMaterial({color:0xff0000}));
  obs.position.set(x,0.25,z); scene.add(obs); obstacles.push(obs);
}
for(let i=10;i<200;i+=20){ addObstacle(-1,i); addObstacle(1,i+10); }

// Load car from GitHub
const loader=new THREE.GLTFLoader();
loader.load(
  'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumMilkTruck/glTF-Binary/CesiumMilkTruck.glb',
  function(gltf){
    car=gltf.scene;
    car.scale.set(0.5,0.5,0.5);
    car.position.z=-5;
    scene.add(car);
  },
  undefined,
  function(e){ console.error('Error loading model:', e);}
);

// Controls
document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') moveLeft=true; if(e.key==='ArrowRight') moveRight=true; });
document.addEventListener('keyup', e=>{ if(e.key==='ArrowLeft') moveLeft=false; if(e.key==='ArrowRight') moveRight=false; });

// Swipe controls
let startX=null;
document.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; });
document.addEventListener('touchmove', e=>{
  if(!startX) return;
  let deltaX=e.touches[0].clientX-startX;
  if(deltaX>30){ moveRight=true; moveLeft=false; startX=null; }
  else if(deltaX<-30){ moveLeft=true; moveRight=false; startX=null; }
});
document.addEventListener('touchend', ()=>{ moveLeft=false; moveRight=false; startX=null; });

// Speed boost
function speedBoost(){ boostActive=true; setTimeout(()=>{ boostActive=false; },1000); }

// Start/reset game
function startGame(){ score=0; combo=0; document.getElementById('score').innerText='Score: 0'; document.getElementById('combo').innerText='Combo: 0';
  if(car) car.position.x=0; camera.position.set(0,5,10); camera.lookAt(0,0,0);
}

// Animate
function animate(){
  requestAnimationFrame(animate);
  let currentSpeed = boostActive? boostSpeed: speed;

  if(car){
    if(moveLeft) car.position.x-=0.12;
    if(moveRight) car.position.x+=0.12;
    if(car.position.x<-laneWidth) car.position.x=-laneWidth;
    if(car.position.x>laneWidth) car.position.x=laneWidth;
  }

  // Move road, trees, coins, obstacles
  road.position.z+=currentSpeed; if(road.position.z>100) road.position.z=-100;
  trees.forEach(t=>{ t.trunk.position.z+=currentSpeed; t.leaves.position.z+=currentSpeed; if(t.trunk.position.z>100){ t.trunk.position.z-=200; t.leaves.position.z-=200; } });

  coins.forEach(c=>{
    c.position.z+=currentSpeed;
    if(c.position.z>10) c.position.z-=200;
    if(car && Math.abs(c.position.z-car.position.z)<0.5 && Math.abs(c.position.x-car.position.x)<0.5){
      score++; combo++; document.getElementById('score').innerText='Score: '+score; document.getElementById('combo').innerText='Combo: '+combo;
      c.position.z-=200;
      clearTimeout(comboTimer); comboTimer=setTimeout(()=>{ combo=0; document.getElementById('combo').innerText='Combo: 0'; },2000);
    }
  });

  obstacles.forEach(o=>{
    o.position.z+=currentSpeed;
    if(o.position.z>10) o.position.z-=200;
    if(car && Math.abs(o.position.z-car.position.z)<0.5 && Math.abs(o.position.x-car.position.x)<0.5){
      alert('Game Over! Score: '+score);
      startGame();
    }
  });

  renderer.render(scene,camera);
}
animate();

// Resize
window.addEventListener('resize', ()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
</script>
</body>
</html>
