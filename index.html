doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Fruit Cut ‚Äî Final</title>
<style>
  :root{
    --accent:#00ffd5; --danger:#ff6b6b; --ink:#0b1220;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:#0a0f14;color:#eef6f7;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}

  /* Background layers */
  #bg{position:fixed;inset:0;z-index:0;background:
      radial-gradient(120% 120% at 50% 15%, #0e1626 0%, #08121d 60%, #050b12 100%)}
  #shade{position:fixed;inset:0;z-index:1;pointer-events:none;
      background:radial-gradient(130% 130% at 50% 10%, rgba(0,0,0,.1) 0%, rgba(0,0,0,.45) 65%, rgba(0,0,0,.65) 100%)}

  /* Game plane */
  #wrap{position:fixed;inset:0;z-index:2}
  canvas{position:absolute;inset:0;display:block;touch-action:none}

  /* HUD */
  .hud{position:fixed;left:12px;right:12px;top:10px;z-index:5;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{
    padding:8px 12px;border-radius:12px;font-weight:800;letter-spacing:.3px;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
    box-shadow:0 8px 26px rgba(0,0,0,.35);backdrop-filter:blur(6px)
  }
  .score{color:#8ff6ff}.lives{color:#ffd6a5}.lvl{color:#b4ffb4}

  /* Controls */
  .controls{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:6;
    display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{
    --bd:2px; padding:10px 16px;border-radius:999px;cursor:pointer;outline:none;
    color:var(--accent);background:transparent;border:var(--bd) solid rgba(0,255,213,.22);
    font-weight:800;letter-spacing:.3px;position:relative;overflow:hidden;
    transition:transform .16s ease, box-shadow .16s ease;
    box-shadow:0 8px 26px rgba(0,0,0,.45)
  }
  .btn:before{
    content:"";position:absolute;inset:0;border-radius:999px;padding:var(--bd);
    background:linear-gradient(90deg,var(--accent),#6cf,#ff6b6b);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;opacity:.18
  }
  .btn:hover{transform:translateY(-3px);box-shadow:0 12px 34px rgba(0,0,0,.6)}
  .btn:active{transform:translateY(-1px) scale(.98)}
  .btn.red{border-color:rgba(255,107,107,.28);color:var(--danger)}
  .hidden{display:none}

  /* Start + GameOver overlays */
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:7;background:rgba(0,0,0,.35);backdrop-filter:blur(3px)}
  .card{min-width:280px;max-width:92vw;padding:20px;border-radius:16px;text-align:center;
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.2));
    border:1px solid rgba(255,255,255,.1);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  .bigbtn{padding:14px 26px;border-radius:999px;border:3px solid var(--accent);background:transparent;color:var(--accent);font-weight:900;cursor:pointer}

  /* Shop */
  .modal{position:fixed;inset:0;z-index:8;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(3px)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .item{padding:10px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:9;background:rgba(0,0,0,.8);color:#fff;padding:8px 14px;border-radius:999px;display:none}

  .help{position:fixed;left:12px;bottom:10px;color:#cfe;opacity:.8;font-size:12px;z-index:6}
</style>
</head>
<body>
  <div id="bg"></div>
  <div id="shade"></div>

  <div id="wrap">
    <canvas id="game"></canvas>
  </div>

  <div class="hud">
    <div class="pill score">Score: <span id="score">0</span></div>
    <div class="pill lives">Lives: <span id="lives">3</span></div>
    <div class="pill lvl">Level: <span id="level">1</span></div>
    <div class="pill">Coins: <span id="coins">0</span></div>
    <div style="flex:1"></div>
    <div class="pill">Blade: <span id="bladeName">Neon</span></div>
  </div>

  <div class="controls">
    <button id="startBtn" class="btn">Start</button>
    <button id="pauseBtn" class="btn hidden">Pause</button>
    <button id="restartBtn" class="btn red hidden">Restart</button>
    <label class="btn" for="bgFile">Upload PNG</label>
    <input id="bgFile" type="file" accept="image/png,image/jpeg" style="display:none"/>
    <button id="bgToggle" class="btn">BG: Neon</button>
    <button id="shopBtn" class="btn">Shop</button>
  </div>

  <div class="help">Swipe to cut fruits ‚Ä¢ Avoid üí£ ‚Ä¢ ‚ÄúBG: Neon/Wood‚Äù se wooden background ON/OFF</div>

  <!-- Start -->
  <div id="startOverlay" class="overlay">
    <div class="card">
      <h2 style="margin:0 0 6px;color:var(--accent)">Fruit Cut ‚Äî Final</h2>
      <p style="margin:0 0 10px">Tap START ‚Ä¢ Fruits slow ‚Ä¢ Split + particles ‚Ä¢ Simple shop</p>
      <button id="bigStart" class="bigbtn">START</button>
    </div>
  </div>

  <!-- Game Over -->
  <div id="gameOver" class="overlay hidden">
    <div class="card">
      <h2 style="margin:0 0 6px;color:#ff9f9f">GAME OVER</h2>
      <p style="margin:0">Score: <b id="finalScore">0</b></p>
      <p style="margin:6px 0 12px">Best: <b id="bestScore">0</b></p>
      <button id="playAgain" class="btn">Play Again</button>
    </div>
  </div>

  <!-- Shop -->
  <div id="shop" class="modal">
    <div class="card" style="min-width:320px">
      <h3 style="margin:0 0 8px">Shop</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <div>Coins: <b id="shopCoins">0</b></div>
        <div style="flex:1"></div>
        <button id="closeShop" class="btn">Close</button>
      </div>
      <div><b>Blade Trails</b></div>
      <div id="bladeGrid" class="grid" style="margin-top:8px"></div>
      <div style="margin-top:12px"><b>Backgrounds</b></div>
      <div id="bgGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===========================================================
   FINAL FRUIT CUT ‚Äî All-in-One (no external assets needed)
   - Slow fruits, bomb -> game over, split pieces, particles
   - Built-in transparent "wood" SVG background (tile)
   - Upload PNG background support
   - Simple shop: blade trails + backgrounds (uses coins)
   - Simple level system (speed scales every 20 points)
   =========================================================== */

/* ---------- Canvas Setup ---------- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha:true });
let DPR = Math.min(window.devicePixelRatio || 1, 2);
function resize(){
  DPR = Math.min(window.devicePixelRatio || 1, 2);
  canvas.width = Math.floor(window.innerWidth * DPR);
  canvas.height = Math.floor(window.innerHeight * DPR);
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
resize(); addEventListener('resize', resize);

/* ---------- UI Elements ---------- */
const ui = {
  startOverlay: document.getElementById('startOverlay'),
  bigStart: document.getElementById('bigStart'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  restartBtn: document.getElementById('restartBtn'),
  gameOver: document.getElementById('gameOver'),
  playAgain: document.getElementById('playAgain'),
  score: document.getElementById('score'),
  lives: document.getElementById('lives'),
  level: document.getElementById('level'),
  coins: document.getElementById('coins'),
  bestScore: document.getElementById('bestScore'),
  finalScore: document.getElementById('finalScore'),
  bg: document.getElementById('bg'),
  bgToggle: document.getElementById('bgToggle'),
  bgFile: document.getElementById('bgFile'),
  bladeName: document.getElementById('bladeName'),
  shop: document.getElementById('shop'),
  shopBtn: document.getElementById('shopBtn'),
  closeShop: document.getElementById('closeShop'),
  shopCoins: document.getElementById('shopCoins'),
  bladeGrid: document.getElementById('bladeGrid'),
  bgGrid: document.getElementById('bgGrid'),
  toast: document.getElementById('toast')
};

/* ---------- Game State ---------- */
const FRUITS = ['üçâ','üçé','üçä','üçã','üçì','üçç','ü•ù'];
const BOMB = 'üí£';
let fruits=[], bombs=[], pieces=[], particles=[], trails=[];
let running=false, paused=false;
let score=0, lives=3, level=1, coins=0, best=0;
let spawnTimer=0;

/* Levels: every 20 points -> harder a little */
function updateLevel(){
  const newLvl = Math.floor(score/20)+1;
  if(newLvl!==level){ level = newLvl; ui.level.textContent = level; toast(`Level ${level}`); }
}

/* Physics (slow base, scales with level) */
const BASE = { GRAV:0.38, VY_MIN:-9.2, VY_MAX:-7.2, VX:3.0 };
function scale(val){ return val + (level-1)*0.25; } // gentle increase

/* ---------- Backgrounds ---------- */
/* Built-in transparent wood SVG (tile) */
const woodSVG = encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'>
  <defs>
    <linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
      <stop offset='0%' stop-color='#7b5a2b' stop-opacity='0.15'/>
      <stop offset='100%' stop-color='#4e351a' stop-opacity='0.15'/>
    </linearGradient>
  </defs>
  <rect width='256' height='256' fill='url(#g)'/>
  <g fill='none' stroke='#3a2813' stroke-opacity='.22' stroke-width='4'>
    <path d='M0,40 C60,20 120,60 180,40 C220,28 250,38 256,36'/>
    <path d='M0,100 C60,80 120,120 180,100 C220,88 250,98 256,96'/>
    <path d='M0,160 C60,140 120,180 180,160 C220,148 250,158 256,156'/>
    <path d='M0,220 C60,200 120,240 180,220 C220,208 250,218 256,216'/>
  </g>
  <g fill='#3a2813' fill-opacity='.25'>
    <circle cx='40' cy='90' r='6'/>
    <circle cx='210' cy='190' r='5'/>
  </g>
</svg>`);
const BUILTIN_BACKGROUNDS = [
  { id:'neon', name:'Neon',  type:'css',  value:"radial-gradient(120% 120% at 50% 15%, #0e1626 0%, #08121d 60%, #050b12 100%)"},
  { id:'wood', name:'Wood',  type:'img',  value:`url("data:image/svg+xml;utf8,${woodSVG}")`, repeat:true }
];
let currentBg = 'neon';
function applyBG(id){
  const bg = BUILTIN_BACKGROUNDS.find(b=>b.id===id) || BUILTIN_BACKGROUNDS[0];
  currentBg = bg.id;
  if(bg.type==='css'){
    ui.bg.style.background = bg.value;
    ui.bg.style.backgroundSize='cover'; ui.bg.style.backgroundRepeat='no-repeat';
  }else{
    ui.bg.style.backgroundImage = bg.value;
    ui.bg.style.backgroundColor = 'transparent';
    ui.bg.style.backgroundRepeat = bg.repeat ? 'repeat' : 'no-repeat';
    ui.bg.style.backgroundSize = bg.repeat ? '256px 256px' : 'cover';
  }
  ui.bgToggle.textContent = `BG: ${bg.name}`;
}
applyBG('neon');

/* Upload PNG to background */
ui.bgFile.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const r = new FileReader(); r.onload = () => {
    ui.bg.style.backgroundImage = `url('${r.result}')`;
    ui.bg.style.backgroundRepeat = 'no-repeat';
    ui.bg.style.backgroundSize = 'cover';
    ui.bgToggle.textContent = 'BG: Custom';
  }; r.readAsDataURL(f);
});
ui.bgToggle.addEventListener('click', ()=>{
  applyBG(currentBg==='neon' ? 'wood' : 'neon');
});

/* ---------- Shop (simple) ---------- */
const BLADES = [
  { id:'neon',  name:'Neon',  color:'rgba(0,255,213,', price:0 },
  { id:'ice',   name:'Ice',   color:'rgba(160,220,255,', price:25 },
  { id:'fire',  name:'Fire',  color:'rgba(255,120,80,', price:35 },
  { id:'violet',name:'Violet',color:'rgba(200,160,255,', price:45 },
];
const BGS = [
  { id:'neon', name:'Neon', price:0 },
  { id:'wood', name:'Wood', price:15 },
];

let owned = { blades:['neon'], bgs:['neon'], blade:'neon', bg:'neon' };
function save(){ localStorage.setItem('fc_final_state', JSON.stringify({coins, best, owned})); }
function load(){
  try{ const d = JSON.parse(localStorage.getItem('fc_final_state')||'{}');
    coins = d.coins||0; best = d.best||0; if(d.owned) owned=d.owned;
    applyBG(owned.bg||'neon'); setBlade(owned.blade||'neon');
  }catch(e){}
}
load();

function setBlade(id){
  owned.blade = id; ui.bladeName.textContent = BLADES.find(b=>b.id===id)?.name||'Neon';
  save();
}
function renderShop(){
  ui.shopCoins.textContent = coins;
  ui.bladeGrid.innerHTML = '';
  BLADES.forEach(b=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `
      <div style="font-weight:800">${b.name}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:44px;height:10px;border-radius:4px;background:${b.color}0.9)"></div>
        <button class="btn" data-id="${b.id}">${owned.blades.includes(b.id)?'Use':`Buy ${b.price}`}</button>
      </div>`;
    ui.bladeGrid.appendChild(div);
  });
  ui.bgGrid.innerHTML = '';
  BGS.forEach(bg=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `
      <div style="font-weight:800">${bg.name}</div>
      <button class="btn" data-bg="${bg.id}">${owned.bgs.includes(bg.id)?'Apply':`Buy ${bg.price}`}</button>`;
    ui.bgGrid.appendChild(div);
  });

  ui.bladeGrid.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-id');
      if(owned.blades.includes(id)){ setBlade(id); toast(`Blade: ${BLADES.find(x=>x.id===id).name}`); }
      else if(coins>=BLADES.find(x=>x.id===id).price){ coins -= BLADES.find(x=>x.id===id).price; owned.blades.push(id); setBlade(id); toast('Purchased!'); renderShop(); updateHUD(); }
      else toast('Not enough coins');
    };
  });
  ui.bgGrid.querySelectorAll('button').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-bg');
      if(owned.bgs.includes(id)){ owned.bg=id; applyBG(id); toast(`Background: ${id}`); save(); }
      else if(coins>=BGS.find(x=>x.id===id).price){ coins -= BGS.find(x=>x.id===id).price; owned.bgs.push(id); owned.bg=id; applyBG(id); toast('Purchased!'); renderShop(); updateHUD(); }
      else toast('Not enough coins');
    };
  });
}
function openShop(){ renderShop(); ui.shop.style.display='flex'; }
function closeShop(){ ui.shop.style.display='none'; }
ui.shopBtn.onclick=openShop; ui.closeShop.onclick=closeShop;

/* ---------- Trail & Input ---------- */
let pointerDown=false; let trails=[];
function addTrail(x,y){ trails.push({x,y,t:Date.now()}); if(trails.length>120) trails.shift(); }
function clearTrailSoon(){ setTimeout(()=> trails=[], 80); }
function pointer(e){ return e.touches?.[0] ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : {x:e.clientX,y:e.clientY}; }

canvas.addEventListener('mousedown', e=>{ pointerDown=true; const p=pointer(e); addTrail(p.x,p.y); });
canvas.addEventListener('mousemove', e=>{ if(!pointerDown) return; const p=pointer(e); const L=trails[trails.length-1]; if(!L||Math.hypot(p.x-L.x,p.y-L.y)>3) addTrail(p.x,p.y); });
canvas.addEventListener('mouseup', ()=>{ pointerDown=false; clearTrailSoon(); });
canvas.addEventListener('touchstart', e=>{ pointerDown=true; const p=pointer(e); addTrail(p.x,p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener('touchmove', e=>{ if(!pointerDown) return; const p=pointer(e); const L=trails[trails.length-1]; if(!L||Math.hypot(p.x-L.x,p.y-L.y)>2.5) addTrail(p.x,p.y); e.preventDefault(); }, {passive:false});
canvas.addEventListener('touchend', ()=>{ pointerDown=false; clearTrailSoon(); }, {passive:false});

/* ---------- Utils ---------- */
function rand(a,b){ return Math.random()*(b-a)+a; }
function distPointToSegment(px,py,x1,y1,x2,y2){
  const dx=x2-x1, dy=y2-y1, l2=dx*dx+dy*dy; if(l2===0) return Math.hypot(px-x1,py-y1);
  let t=((px-x1)*dx+(py-y1)*dy)/l2; t=Math.max(0,Math.min(1,t));
  const sx=x1+t*dx, sy=y1+t*dy; return Math.hypot(px-sx,py-sy);
}

/* ---------- Spawn / Effects ---------- */
function spawn(){
  const baseX = rand(window.innerWidth*0.2, window.innerWidth*0.8);
  const cluster = Math.random() < 0.10 ? 2 : 1;
  for(let i=0;i<cluster;i++){
    const isBomb = Math.random() < 0.12;
    const o = {
      isBomb,
      emoji: isBomb?BOMB:FRUITS[(Math.random()*FRUITS.length)|0],
      x: baseX + rand(-70,70),
      y: window.innerHeight + 60 + Math.random()*30,
      vx: rand(-scale(BASE.VX), scale(BASE.VX)),
      vy: rand(scale(BASE.VY_MAX), scale(BASE.VY_MIN)),
      size: isBomb?rand(46,58):rand(40,52),
      rot: rand(-0.06,0.06),
      life: 1
    };
    (isBomb?bombs:fruits).push(o);
  }
}
function burst(x,y){
  for(let i=0;i<12;i++){
    particles.push({x,y, vx:rand(-4,4), vy:rand(-6,-1), g:0.18, r:rand(2,5), life:40+Math.random()*30});
  }
}
function addPieces(f){
  const s=3.5;
  pieces.push({emoji:f.emoji, side:'L', x:f.x-2, y:f.y, vx:f.vx-s, vy:f.vy-1.2, rot:f.rot-0.05, size:f.size, life:28});
  pieces.push({emoji:f.emoji, side:'R', x:f.x+2, y:f.y, vx:f.vx+s, vy:f.vy-1.2, rot:f.rot+0.05, size:f.size, life:28});
}

/* ---------- Game Loop ---------- */
function checkSlicing(){
  if(trails.length<2) return;
  const pts = trails.slice(-18);
  for(let s=0;s<pts.length-1;s++){
    const a=pts[s], b=pts[s+1];
    for(let i=fruits.length-1;i>=0;i--){
      const f=fruits[i];
      const d=distPointToSegment(f.x,f.y,a.x,a.y,b.x,b.y);
      if(d < f.size*0.55){
        fruits.splice(i,1);
        score += 1; coins += 1;
        burst(f.x,f.y); addPieces(f);
        ui.score.textContent=score; ui.coins.textContent=coins;
        updateLevel(); save();
      }
    }
    for(let i=bombs.length-1;i>=0;i--){
      const bo=bombs[i];
      const d=distPointToSegment(bo.x,bo.y,a.x,a.y,b.x,b.y);
      if(d < bo.size*0.6){ endGame(); return; }
    }
  }
}
function update(){
  // spawn
  spawnTimer -= 1;
  if(spawnTimer<=0){ spawn(); spawnTimer = 28 + Math.floor(Math.random()*18) - Math.min(12, level*2); }

  const GRAV = BASE.GRAV + (level-1)*0.02;

  fruits.forEach(f=>{ f.vy += GRAV; f.x += f.vx; f.y += f.vy; f.vx *= 0.997; });
  bombs.forEach(b=>{ b.vy += GRAV; b.x += b.vx; b.y += b.vy; b.vx *= 0.997; });
  pieces.forEach(p=>{ p.vy += GRAV*0.9; p.x += p.vx; p.y += p.vy; p.rot += (p.side==='L'?-0.05:0.05); p.life -= 1; });
  particles.forEach(pr=>{ pr.vy += 0.18; pr.x += pr.vx; pr.y += pr.vy; pr.life -= 1; });

  // offscreen & lives
  for(let i=fruits.length-1;i>=0;i--){
    const f=fruits[i];
    if(f.y - f.size > window.innerHeight + 80){
      fruits.splice(i,1);
      lives--; ui.lives.textContent=lives;
      if(lives<=0){ endGame(); return; }
    }
  }
  for(let i=bombs.length-1;i>=0;i--) if(bombs[i].y - bombs[i].size > window.innerHeight + 80) bombs.splice(i,1);
  for(let i=pieces.length-1;i>=0;i--) if(pieces[i].life<=0) pieces.splice(i,1);
  for(let i=particles.length-1;i>=0;i--) if(particles[i].life<=0) particles.splice(i,1);

  // trail decay + slicing
  const now = Date.now(); trails = trails.filter(pt => now - pt.t < 220);
  checkSlicing();
}
function draw(){
  ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
  const w=canvas.width/DPR, h=canvas.height/DPR;

  // fruits
  fruits.forEach(f=>{
    ctx.save(); ctx.translate(f.x,f.y); ctx.rotate(f.rot);
    ctx.font = Math.floor(f.size)+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,.45)'; ctx.shadowBlur=8;
    ctx.fillText(f.emoji,0,0); ctx.restore();
  });
  // bombs
  bombs.forEach(b=>{
    ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.rot);
    ctx.font = Math.floor(b.size)+'px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowColor='rgba(255,80,80,.18)'; ctx.shadowBlur=10;
    ctx.fillText(b.emoji,0,0); ctx.restore();
  });
